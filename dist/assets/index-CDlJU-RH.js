var oe=Object.defineProperty;var ie=(r,t,s)=>t in r?oe(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var D=(r,t,s)=>ie(r,typeof t!="symbol"?t+"":t,s);import{c as N,d as q,j as e,r as w,L as le,S as ce,E as de,g as ue,b as B,a as R,e as _,f as O,R as pe}from"./globals-DhsXFkrn.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],he=N("check",me);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],fe=N("chevron-down",xe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],ye=N("chevron-up",ge);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],be=N("circle-alert",we);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3",key:"11bfej"}]],ve=N("command",je);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],ke=N("copy",Ne);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],Ce=N("globe",Se);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]],_e=N("log-in",Ee);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M14 4.1 12 6",key:"ita8i4"}],["path",{d:"m5.1 8-2.9-.8",key:"1go3kf"}],["path",{d:"m6 12-1.9 2",key:"mnht97"}],["path",{d:"M7.2 2.2 8 5.1",key:"1cfko1"}],["path",{d:"M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z",key:"s0h3yz"}]],Ue=N("mouse-pointer-click",Le);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Te=N("refresh-cw",$e);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Re=N("share-2",Ae);class Me{constructor(){D(this,"cache",new Map)}async generate(t){const{question:s,answer:n,complexityLevel:a,conversationContext:o=[]}=t,i=this.getCacheKey(s,a);if(this.cache.has(i))return this.cache.get(i);try{const m=(await q.request("/api/followups/generate",{method:"POST",body:JSON.stringify({question:s,answer:n,complexityLevel:a,conversationContext:o}),requiresAuth:!1})).followUps||[],c=this.validateFollowUps(m,s);if(this.cache.set(i,c),this.cache.size>50){const d=this.cache.keys().next().value;this.cache.delete(d)}return c}catch(p){return console.error("❌ Failed to generate follow-ups:",p),this.generateLocal(t)}}generateLocal(t){const{question:s,complexityLevel:n}=t,a=this.extractTopic(s);return this.getTemplates(n).map((i,p)=>{const m=["deeper","related","practical"];return{id:`local-${Date.now()}-${p}`,text:i.replace("{topic}",a),category:m[p]||"related"}})}getTemplates(t){const s={"5yo":["Why is {topic} important?","What else works like {topic}?","Can you show me {topic} with a picture?"],normal:["How does {topic} actually work?","What are some real-world examples of {topic}?","What are the limitations of {topic}?"],advanced:["What are the technical details of {topic}?","How does {topic} compare to alternatives?","What are the edge cases of {topic}?"]};return s[t]||s.normal}extractTopic(t){const n=t.toLowerCase().replace(/^(what|how|why|when|where|who|can you|could you|please|explain|tell me about)\s+/gi,"").replace(/[?.!,]/g,"").trim().split(" ");return n.slice(0,Math.min(4,n.length)).join(" ")}validateFollowUps(t,s){const n=[],a=new Set;for(const o of t){if(!this.isValidFollowUp(o,s))continue;const i=o.text.toLowerCase().trim();if(!a.has(i)&&(a.add(i),n.push(o),n.length>=3))break}return n}isValidFollowUp(t,s){const n=t.text.trim();return!(n.length<10||n.length>150||this.calculateSimilarity(n,s)>.8||!this.isQuestion(n)||!["deeper","related","practical"].includes(t.category))}isQuestion(t){return t.endsWith("?")||/^(what|how|why|when|where|who|can|could|would|should|is|are|do|does)/i.test(t)}calculateSimilarity(t,s){const n=new Set(t.toLowerCase().split(/\s+/)),a=new Set(s.toLowerCase().split(/\s+/)),o=new Set([...n].filter(p=>a.has(p))),i=new Set([...n,...a]);return o.size/i.size}getCacheKey(t,s){return`${t.toLowerCase().trim()}-${s}`}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}assignCategories(t){return t.map((s,n)=>{const a=this.inferCategory(s,n);return{id:`generated-${Date.now()}-${n}`,text:s,category:a}})}inferCategory(t,s){const n=t.toLowerCase();return n.includes("why")||n.includes("how does")||n.includes("explain more")||n.includes("detail")?"deeper":n.includes("example")||n.includes("use")||n.includes("apply")||n.includes("real world")||n.includes("practice")?"practical":n.includes("similar")||n.includes("related")||n.includes("other")||n.includes("compare")?"related":["deeper","related","practical"][s%3]}}const Fe=new Me;var Ie={};async function De(r,t,s=[],n){const{onToken:a,onComplete:o,onError:i,signal:p}=n;let m="",c=null;try{const d=await q.getAccessToken();if(!d)throw new Error("Not authenticated");c=new AbortController,p&&p.addEventListener("abort",()=>{c==null||c.abort()});const v=[...s,{role:"user",content:r}],y=await fetch(`${Ie.VITE_API_URL||"https://stupify.app"}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({messages:v,simplicityLevel:t}),signal:c.signal});if(!y.ok){const k=await y.json();throw new Error(k.error||k.message||"Chat request failed")}if(!y.body)throw new Error("No response body");const f=y.body.getReader(),b=new TextDecoder;for(;;){const{done:k,value:$}=await f.read();if(k)break;const T=b.decode($,{stream:!0}).split(`
`).filter(S=>S.trim());for(const S of T)try{if(!S.trim())continue;let j=S;S.includes(":")&&(j=S.split(":").slice(1).join(":"));try{const C=JSON.parse(j);C.content?j=C.content:typeof C=="string"&&(j=C)}catch{}j&&j.trim()&&(a(j),m+=j)}catch(j){console.error("Error parsing chunk:",j)}}o(m)}catch(d){if(d instanceof Error&&d.name==="AbortError"){console.log("🛑 Stream cancelled");return}console.error("❌ Stream error:",d),i(d)}}function P(){const r=new AbortController;return{signal:r.signal,cancel:()=>r.abort()}}async function z(r,t,s=[],n,a=2){let o=null;for(let i=0;i<a;i++)try{await De(r,t,s,n);return}catch(p){if(o=p,o.message.includes("authenticated")||o.name==="AbortError")throw o;if(i<a-1){const m=Math.min(1e3*Math.pow(2,i),3e3);await new Promise(c=>setTimeout(c,m))}}throw o||new Error("Stream failed after retries")}const V={"5yo":{label:"5yo",description:"Like I'm 5",emoji:"🧸",color:"bg-pink-500 hover:bg-pink-600",selectedColor:"bg-pink-600 ring-pink-500"},normal:{label:"Normal",description:"Balanced",emoji:"⚖️",color:"bg-primary-500 hover:bg-primary-600",selectedColor:"bg-primary-600 ring-primary-500"},advanced:{label:"Advanced",description:"Technical",emoji:"🧠",color:"bg-purple-600 hover:bg-purple-700",selectedColor:"bg-purple-700 ring-purple-500"}},Oe=({selected:r,onChange:t,disabled:s=!1})=>e.jsx("div",{className:"flex gap-2",children:Object.keys(V).map(n=>{const a=V[n],o=r===n;return e.jsx("button",{onClick:()=>t(n),disabled:s,className:`
              flex-1 px-3 py-2.5 rounded-lg font-medium text-sm
              transition-all duration-200
              disabled:opacity-50 disabled:cursor-not-allowed
              ${o?`${a.selectedColor} text-white ring-2 ring-offset-2 shadow-md`:"bg-white text-gray-700 hover:bg-gray-50 border border-gray-200"}
            `,children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-lg",children:a.emoji}),e.jsx("span",{className:"font-semibold",children:a.label}),e.jsx("span",{className:"text-xs opacity-75",children:a.description})]})},n)})}),Pe=({text:r,isStreaming:t,isLoading:s})=>{const n=w.useRef(null);return w.useEffect(()=>{t&&n.current&&n.current.scrollIntoView({behavior:"smooth"})},[r,t]),s&&!r?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(le,{className:"w-8 h-8 text-primary-600 animate-spin mx-auto"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Thinking..."})]})}):r?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsxs("div",{className:"text-gray-800 leading-relaxed whitespace-pre-wrap",children:[r,t&&e.jsx("span",{className:"inline-block w-0.5 h-4 ml-1 bg-primary-600 animate-pulse"})]})}),e.jsx("div",{ref:n})]}):null},ze=({questions:r,onQuestionClick:t})=>r.length===0?null:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4 text-primary-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Keep Learning"})]}),e.jsx("div",{className:"space-y-2",children:r.map(s=>e.jsx("button",{onClick:()=>t(s),disabled:s.clicked,className:`
              w-full text-left px-4 py-3 rounded-lg
              transition-all duration-200
              ${s.clicked?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-primary-50 border border-gray-200 hover:border-primary-300 text-gray-700 hover:text-primary-700"}
            `,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary-500 mt-0.5",children:"→"}),e.jsx("span",{className:"text-sm",children:s.question})]})},s.id))})]}),Ve=({response:r,onOpenInApp:t})=>{const[s,n]=w.useState(!1),a=async()=>{try{await navigator.clipboard.writeText(r),n(!0),setTimeout(()=>n(!1),2e3)}catch(i){console.error("Failed to copy:",i)}},o=async()=>{if(navigator.share)try{await navigator.share({title:"Stupify Explanation",text:r})}catch{console.log("Share cancelled or failed")}else a()};return e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:a,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:s?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-green-600",children:"Copied!"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-4 h-4"}),e.jsx("span",{children:"Copy"})]})}),e.jsxs("button",{onClick:o,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:[e.jsx(Re,{className:"w-4 h-4"}),e.jsx("span",{children:"Share"})]}),t&&e.jsxs("button",{onClick:t,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors",children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{children:"Open App"})]})]})},Qe=({error:r,onRetry:t})=>e.jsx("div",{className:"rounded-lg bg-red-50 border border-red-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(be,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-red-900",children:"Something went wrong"}),e.jsx("p",{className:"text-sm text-red-700",children:r}),t&&e.jsxs("button",{onClick:t,className:"flex items-center gap-2 px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-md text-sm font-medium transition-colors",children:[e.jsx(Te,{className:"w-4 h-4"}),"Try Again"]})]})]})}),We=()=>e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(Ue,{className:"w-8 h-8 text-primary-600"})}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Select Text to Get Started"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6 max-w-sm",children:"Highlight any text on this page and we'll explain it simply."}),e.jsxs("div",{className:"space-y-3 w-full max-w-xs",children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-primary-600 font-bold",children:"1"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Select Text"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Highlight any text on the page"})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-primary-600 font-bold",children:"2"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Right-Click"}),e.jsx("p",{className:"text-xs text-gray-500",children:'Choose "Simplify with Stupify"'})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ve,{className:"w-4 h-4 text-primary-600"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Or Use Shortcut"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Cmd+Shift+S"})," ","(Mac) or"," ",e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Ctrl+Shift+S"})," ","(Windows)"]})]})]})})]})]}),He={},Q=r=>{let t;const s=new Set,n=(d,v)=>{const y=typeof d=="function"?d(t):d;if(!Object.is(y,t)){const f=t;t=v??(typeof y!="object"||y===null)?y:Object.assign({},t,y),s.forEach(b=>b(t,f))}},a=()=>t,m={setState:n,getState:a,getInitialState:()=>c,subscribe:d=>(s.add(d),()=>s.delete(d)),destroy:()=>{(He?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),s.clear()}},c=t=r(n,a,m);return m},qe=r=>r?Q(r):Q;var K={exports:{}},G={},J={exports:{}},X={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var L=w;function Be(r,t){return r===t&&(r!==0||1/r===1/t)||r!==r&&t!==t}var Ke=typeof Object.is=="function"?Object.is:Be,Ge=L.useState,Je=L.useEffect,Xe=L.useLayoutEffect,Ye=L.useDebugValue;function Ze(r,t){var s=t(),n=Ge({inst:{value:s,getSnapshot:t}}),a=n[0].inst,o=n[1];return Xe(function(){a.value=s,a.getSnapshot=t,M(a)&&o({inst:a})},[r,s,t]),Je(function(){return M(a)&&o({inst:a}),r(function(){M(a)&&o({inst:a})})},[r]),Ye(s),s}function M(r){var t=r.getSnapshot;r=r.value;try{var s=t();return!Ke(r,s)}catch{return!0}}function et(r,t){return t()}var tt=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?et:Ze;X.useSyncExternalStore=L.useSyncExternalStore!==void 0?L.useSyncExternalStore:tt;J.exports=X;var st=J.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var U=w,rt=st;function nt(r,t){return r===t&&(r!==0||1/r===1/t)||r!==r&&t!==t}var at=typeof Object.is=="function"?Object.is:nt,ot=rt.useSyncExternalStore,it=U.useRef,lt=U.useEffect,ct=U.useMemo,dt=U.useDebugValue;G.useSyncExternalStoreWithSelector=function(r,t,s,n,a){var o=it(null);if(o.current===null){var i={hasValue:!1,value:null};o.current=i}else i=o.current;o=ct(function(){function m(f){if(!c){if(c=!0,d=f,f=n(f),a!==void 0&&i.hasValue){var b=i.value;if(a(b,f))return v=b}return v=f}if(b=v,at(d,f))return b;var k=n(f);return a!==void 0&&a(b,k)?(d=f,b):(d=f,v=k)}var c=!1,d,v,y=s===void 0?null:s;return[function(){return m(t())},y===null?void 0:function(){return m(y())}]},[t,s,n,a]);var p=ot(r,o[0],o[1]);return lt(function(){i.hasValue=!0,i.value=p},[p]),dt(p),p};K.exports=G;var ut=K.exports;const pt=ue(ut),Y={},{useDebugValue:mt}=B,{useSyncExternalStoreWithSelector:ht}=pt;let W=!1;const xt=r=>r;function ft(r,t=xt,s){(Y?"production":void 0)!=="production"&&s&&!W&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),W=!0);const n=ht(r.subscribe,r.getState,r.getServerState||r.getInitialState,t,s);return mt(n),n}const H=r=>{(Y?"production":void 0)!=="production"&&typeof r!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t=typeof r=="function"?qe(r):r,s=(n,a)=>ft(t,n,a);return Object.assign(s,t),s},gt=r=>r?H(r):H,yt=gt((r,t)=>({selectedText:null,complexity:"normal",explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[],history:[],isCollapsed:!1,setSelectedText:s=>r({selectedText:s}),setComplexity:s=>r({complexity:s}),startExplanation:()=>r({explanation:{isLoading:!0,isStreaming:!0,response:"",error:null,completed:!1},followUpQuestions:[]}),streamResponse:s=>{const{explanation:n}=t();r({explanation:{...n,isLoading:!1,isStreaming:!0,response:n.response+s}})},completeExplanation:()=>{const{explanation:s,selectedText:n,complexity:a}=t();r({explanation:{...s,isStreaming:!1,completed:!0}}),n&&t().addToHistory({id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,question:n.text,complexity:a,response:s.response,followUps:[],timestamp:Date.now(),url:n.url})},setError:s=>r({explanation:{isLoading:!1,isStreaming:!1,response:"",error:s,completed:!1}}),clearExplanation:()=>r({explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[]}),setFollowUpQuestions:s=>r({followUpQuestions:s}),markFollowUpClicked:s=>{const{followUpQuestions:n}=t();r({followUpQuestions:n.map(a=>a.id===s?{...a,clicked:!0}:a)})},addToHistory:s=>{const{history:n}=t(),a=[s,...n].slice(0,20);r({history:a})},clearHistory:()=>r({history:[]}),toggleCollapse:()=>r(s=>({isCollapsed:!s.isCollapsed}))}));var wt={};const bt=()=>{const{selectedText:r,complexity:t,explanation:s,followUpQuestions:n,isCollapsed:a,setComplexity:o,startExplanation:i,streamResponse:p,completeExplanation:m,setError:c,setFollowUpQuestions:d,markFollowUpClicked:v,toggleCollapse:y,setSelectedText:f}=yt(),[b,k]=w.useState(!1),[$,F]=w.useState(10),[T,S]=w.useState(!1),[j,C]=w.useState(!1),E=w.useRef(null);w.useEffect(()=>{const u=R.subscribe(l=>{var g;k(l.isAuthenticated),S(((g=l.user)==null?void 0:g.subscription_tier)==="premium")});return R.checkAuthStatus(),u},[]),w.useEffect(()=>_.subscribe(l=>{F(l.remaining)}),[]),w.useEffect(()=>{C(!1)},[]),w.useEffect(()=>{const u=l=>{l.type==="OPEN_SIDE_PANEL"&&console.log("Opening side panel with text:",l.payload)};return chrome.runtime.onMessage.addListener(u),()=>chrome.runtime.onMessage.removeListener(u)},[]);const Z=u=>{try{return new URL(u).hostname.replace("www.","")}catch{return"Unknown"}},A=async()=>{if(!r)return;if(!_.canAsk()){c("Daily limit reached! Upgrade for unlimited questions.");return}const u=r.text;i();const l=await O.get(u,t);if(l){console.log("✅ Using cached response");const x=l.answer.split(" ");for(const h of x)p(h+" "),await new Promise(ae=>setTimeout(ae,30));m(),I(u,l.answer);return}const g=P();E.current=g;try{let x="";await z(u,t,[],{signal:g.signal,onToken:h=>{x+=h,p(h)},onComplete:async h=>{m(),await O.add(u,h,t),await _.recordQuestion(),I(u,h)},onError:h=>{c(h.message||"Failed to get explanation"),console.error("❌ Stream error:",h)}})}catch(x){c(x.message||"Failed to get explanation"),console.error("❌ Ask error:",x)}};w.useEffect(()=>{(async()=>{try{const{pendingExplanation:l}=await chrome.storage.local.get("pendingExplanation");if(l!=null&&l.text){const g=l.text;console.log("📝 Found pending explanation:",g.substring(0,50)+"..."),f(g),await chrome.storage.local.remove("pendingExplanation"),setTimeout(async()=>{if(!_.canAsk()){c("Daily limit reached! Upgrade for unlimited questions.");return}i();try{const x=P();E.current=x,await z(g,t,[],{onToken:h=>p(h),onComplete:()=>{m(),E.current=null},onError:h=>{c(h.message),E.current=null},signal:x.signal},2)}catch(x){console.error("❌ Stream error:",x),c(x.message||"Failed to get explanation")}},500)}}catch(l){console.error("❌ Error checking pending explanation:",l)}})()},[]);const I=async(u,l)=>{try{const x=(await Fe.generate({question:u,answer:l,complexityLevel:t})).map(h=>({id:h.id,question:h.text,category:h.category,clicked:!1}));d(x)}catch(g){console.error("❌ Failed to generate follow-ups:",g)}},ee=()=>{A()},te=u=>{v(u.id),f({text:u.question,url:(r==null?void 0:r.url)||"",domain:(r==null?void 0:r.domain)||"Follow-up",timestamp:Date.now()}),setTimeout(()=>A(),100)},se=()=>{E.current&&(E.current.cancel(),E.current=null)},re=async()=>{try{c("null");const u=`${wt.VITE_API_URL||"https://stupify.app"}/login?ref=extension&mode=popup`,l=window.open(u,"Stupify Login","width=450,height=650,menubar=no,toolbar=no,location=no,status=no"),g=setInterval(async()=>{try{l!=null&&l.closed&&(clearInterval(g),(await R.checkAuthStatus()).isAuthenticated?window.location.reload():c("Login cancelled or failed"))}catch(x){clearInterval(g),console.error("Auth check error:",x)}},1e3);setTimeout(()=>{clearInterval(g),l&&!l.closed&&(l.close(),c("Login timeout"))},5*60*1e3)}catch(u){console.error("❌ Login failed:",u),c("Login failed. Please try again.")}},ne=()=>{window.open("https://stupify.app/chat","_blank")};return e.jsxs("div",{className:"h-screen flex flex-col bg-gradient-to-br from-primary-50 via-purple-50 to-pink-50",children:[e.jsx("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 shadow-sm",children:e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-primary-600 to-purple-600 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-sm",children:"S"})}),e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:"Stupify"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[j&&e.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium",children:"Offline"}),b?e.jsx("div",{className:"flex items-center gap-2 text-sm",children:e.jsx("span",{className:"text-gray-600",children:T?e.jsx("span",{className:"px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded font-medium text-xs",children:"∞ Premium"}):e.jsxs("span",{className:"text-gray-700 font-medium",children:[$," left"]})})}):e.jsxs("button",{onClick:re,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(_e,{className:"w-4 h-4"}),"Login"]})]})]}),e.jsx(Oe,{selected:t,onChange:o,disabled:s.isLoading||s.isStreaming})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"p-6 space-y-6",children:[!r&&e.jsx(We,{}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:e.jsxs("button",{onClick:y,className:"w-full px-4 py-3 flex items-start justify-between gap-3 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex-1 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(Ce,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-xs font-medium text-gray-500",children:Z(r.url)})]}),e.jsx("p",{className:`text-sm text-gray-700 ${a?"line-clamp-2":""}`,children:r.text})]}),a?e.jsx(fe,{className:"w-5 h-5 text-gray-400 flex-shrink-0"}):e.jsx(ye,{className:"w-5 h-5 text-gray-400 flex-shrink-0"})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6",children:[s.error?e.jsx(Qe,{error:s.error,onRetry:ee}):s.response||s.isLoading?e.jsx(Pe,{text:s.response,isStreaming:s.isStreaming,isLoading:s.isLoading}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("button",{onClick:A,"data-testid":"explain-button",disabled:!_.canAsk(),className:"px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:_.canAsk()?"Explain This":"Daily Limit Reached"}),!_.canAsk()&&e.jsx("button",{onClick:()=>window.open("https://stupify.app/pricing","_blank"),className:"mt-3 text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Upgrade for unlimited questions →"})]}),s.isStreaming&&e.jsx("div",{className:"mt-4 text-center",children:e.jsx("button",{onClick:se,className:"text-sm text-gray-600 hover:text-gray-800 font-medium",children:"Cancel"})})]}),s.completed&&s.response&&e.jsx(Ve,{response:s.response,onOpenInApp:ne}),n.length>0&&e.jsx(ze,{questions:n,onQuestionClick:te})]})]})}),e.jsx("div",{className:"flex-shrink-0 bg-white border-t border-gray-200 px-6 py-3",children:e.jsxs("p",{className:"text-xs text-center text-gray-500",children:["Made with 💜 by"," ",e.jsx("a",{href:"https://stupify.app",target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-700 font-medium",children:"Stupify"})]})})]})};pe.createRoot(document.getElementById("root")).render(e.jsx(B.StrictMode,{children:e.jsx(bt,{})}));console.log("✅ Stupify Side Panel loaded");
