var ne=Object.defineProperty;var ae=(s,r,t)=>r in s?ne(s,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[r]=t;var D=(s,r,t)=>ae(s,typeof r!="symbol"?r+"":r,t);import{c as N,d as W,j as e,r as y,L as oe,S as ie,E as le,g as ce,b as H,a as R,e as E,o as de,f as O,R as ue}from"./globals-Ch-Es4C0.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],me=N("check",pe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],xe=N("chevron-down",he);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],ye=N("chevron-up",fe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],we=N("circle-alert",ge);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3",key:"11bfej"}]],je=N("command",be);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ne=N("copy",ve);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],ke=N("globe",Se);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]],Ee=N("log-in",Ce);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["path",{d:"M14 4.1 12 6",key:"ita8i4"}],["path",{d:"m5.1 8-2.9-.8",key:"1go3kf"}],["path",{d:"m6 12-1.9 2",key:"mnht97"}],["path",{d:"M7.2 2.2 8 5.1",key:"1cfko1"}],["path",{d:"M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z",key:"s0h3yz"}]],Le=N("mouse-pointer-click",_e);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],$e=N("refresh-cw",Ue);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Te=N("share-2",Ae);class Re{constructor(){D(this,"cache",new Map)}async generate(r){const{question:t,answer:n,complexityLevel:a,conversationContext:o=[]}=r,i=this.getCacheKey(t,a);if(this.cache.has(i))return this.cache.get(i);try{const m=(await W.request("/api/followups/generate",{method:"POST",body:JSON.stringify({question:t,answer:n,complexityLevel:a,conversationContext:o}),requiresAuth:!1})).followUps||[],l=this.validateFollowUps(m,t);if(this.cache.set(i,l),this.cache.size>50){const c=this.cache.keys().next().value;this.cache.delete(c)}return l}catch(p){return console.error("❌ Failed to generate follow-ups:",p),this.generateLocal(r)}}generateLocal(r){const{question:t,complexityLevel:n}=r,a=this.extractTopic(t);return this.getTemplates(n).map((i,p)=>{const m=["deeper","related","practical"];return{id:`local-${Date.now()}-${p}`,text:i.replace("{topic}",a),category:m[p]||"related"}})}getTemplates(r){const t={"5yo":["Why is {topic} important?","What else works like {topic}?","Can you show me {topic} with a picture?"],normal:["How does {topic} actually work?","What are some real-world examples of {topic}?","What are the limitations of {topic}?"],advanced:["What are the technical details of {topic}?","How does {topic} compare to alternatives?","What are the edge cases of {topic}?"]};return t[r]||t.normal}extractTopic(r){const n=r.toLowerCase().replace(/^(what|how|why|when|where|who|can you|could you|please|explain|tell me about)\s+/gi,"").replace(/[?.!,]/g,"").trim().split(" ");return n.slice(0,Math.min(4,n.length)).join(" ")}validateFollowUps(r,t){const n=[],a=new Set;for(const o of r){if(!this.isValidFollowUp(o,t))continue;const i=o.text.toLowerCase().trim();if(!a.has(i)&&(a.add(i),n.push(o),n.length>=3))break}return n}isValidFollowUp(r,t){const n=r.text.trim();return!(n.length<10||n.length>150||this.calculateSimilarity(n,t)>.8||!this.isQuestion(n)||!["deeper","related","practical"].includes(r.category))}isQuestion(r){return r.endsWith("?")||/^(what|how|why|when|where|who|can|could|would|should|is|are|do|does)/i.test(r)}calculateSimilarity(r,t){const n=new Set(r.toLowerCase().split(/\s+/)),a=new Set(t.toLowerCase().split(/\s+/)),o=new Set([...n].filter(p=>a.has(p))),i=new Set([...n,...a]);return o.size/i.size}getCacheKey(r,t){return`${r.toLowerCase().trim()}-${t}`}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}assignCategories(r){return r.map((t,n)=>{const a=this.inferCategory(t,n);return{id:`generated-${Date.now()}-${n}`,text:t,category:a}})}inferCategory(r,t){const n=r.toLowerCase();return n.includes("why")||n.includes("how does")||n.includes("explain more")||n.includes("detail")?"deeper":n.includes("example")||n.includes("use")||n.includes("apply")||n.includes("real world")||n.includes("practice")?"practical":n.includes("similar")||n.includes("related")||n.includes("other")||n.includes("compare")?"related":["deeper","related","practical"][t%3]}}const Me=new Re;var Ie={};async function Fe(s,r,t=[],n){const{onToken:a,onComplete:o,onError:i,signal:p}=n;let m="",l=null;try{const c=await W.getAccessToken();if(!c)throw new Error("Not authenticated");l=new AbortController,p&&p.addEventListener("abort",()=>{l==null||l.abort()});const j=[...t,{role:"user",content:s}],h=await fetch(`${Ie.VITE_API_URL||"https://stupify.app"}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({messages:j,simplicityLevel:r}),signal:l.signal});if(!h.ok){const S=await h.json();throw new Error(S.error||S.message||"Chat request failed")}if(!h.body)throw new Error("No response body");const x=h.body.getReader(),g=new TextDecoder;for(;;){const{done:S,value:$}=await x.read();if(S)break;const A=g.decode($,{stream:!0}).split(`
`).filter(k=>k.trim());for(const k of A)try{if(!k.trim())continue;let w=k;k.includes(":")&&(w=k.split(":").slice(1).join(":"));try{const C=JSON.parse(w);C.content?w=C.content:typeof C=="string"&&(w=C)}catch{}w&&w.trim()&&(a(w),m+=w)}catch(w){console.error("Error parsing chunk:",w)}}o(m)}catch(c){if(c instanceof Error&&c.name==="AbortError"){console.log("🛑 Stream cancelled");return}console.error("❌ Stream error:",c),i(c)}}function De(){const s=new AbortController;return{signal:s.signal,cancel:()=>s.abort()}}async function Oe(s,r,t=[],n,a=2){let o=null;for(let i=0;i<a;i++)try{await Fe(s,r,t,n);return}catch(p){if(o=p,o.message.includes("authenticated")||o.name==="AbortError")throw o;if(i<a-1){const m=Math.min(1e3*Math.pow(2,i),3e3);await new Promise(l=>setTimeout(l,m))}}throw o||new Error("Stream failed after retries")}const P={"5yo":{label:"5yo",description:"Like I'm 5",emoji:"🧸",color:"bg-pink-500 hover:bg-pink-600",selectedColor:"bg-pink-600 ring-pink-500"},normal:{label:"Normal",description:"Balanced",emoji:"⚖️",color:"bg-primary-500 hover:bg-primary-600",selectedColor:"bg-primary-600 ring-primary-500"},advanced:{label:"Advanced",description:"Technical",emoji:"🧠",color:"bg-purple-600 hover:bg-purple-700",selectedColor:"bg-purple-700 ring-purple-500"}},Pe=({selected:s,onChange:r,disabled:t=!1})=>e.jsx("div",{className:"flex gap-2",children:Object.keys(P).map(n=>{const a=P[n],o=s===n;return e.jsx("button",{onClick:()=>r(n),disabled:t,className:`
              flex-1 px-3 py-2.5 rounded-lg font-medium text-sm
              transition-all duration-200
              disabled:opacity-50 disabled:cursor-not-allowed
              ${o?`${a.selectedColor} text-white ring-2 ring-offset-2 shadow-md`:"bg-white text-gray-700 hover:bg-gray-50 border border-gray-200"}
            `,children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-lg",children:a.emoji}),e.jsx("span",{className:"font-semibold",children:a.label}),e.jsx("span",{className:"text-xs opacity-75",children:a.description})]})},n)})}),ze=({text:s,isStreaming:r,isLoading:t})=>{const n=y.useRef(null);return y.useEffect(()=>{r&&n.current&&n.current.scrollIntoView({behavior:"smooth"})},[s,r]),t&&!s?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(oe,{className:"w-8 h-8 text-primary-600 animate-spin mx-auto"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Thinking..."})]})}):s?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsxs("div",{className:"text-gray-800 leading-relaxed whitespace-pre-wrap",children:[s,r&&e.jsx("span",{className:"inline-block w-0.5 h-4 ml-1 bg-primary-600 animate-pulse"})]})}),e.jsx("div",{ref:n})]}):null},Ve=({questions:s,onQuestionClick:r})=>s.length===0?null:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4 text-primary-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Keep Learning"})]}),e.jsx("div",{className:"space-y-2",children:s.map(t=>e.jsx("button",{onClick:()=>r(t),disabled:t.clicked,className:`
              w-full text-left px-4 py-3 rounded-lg
              transition-all duration-200
              ${t.clicked?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-primary-50 border border-gray-200 hover:border-primary-300 text-gray-700 hover:text-primary-700"}
            `,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary-500 mt-0.5",children:"→"}),e.jsx("span",{className:"text-sm",children:t.question})]})},t.id))})]}),Qe=({response:s,onOpenInApp:r})=>{const[t,n]=y.useState(!1),a=async()=>{try{await navigator.clipboard.writeText(s),n(!0),setTimeout(()=>n(!1),2e3)}catch(i){console.error("Failed to copy:",i)}},o=async()=>{if(navigator.share)try{await navigator.share({title:"Stupify Explanation",text:s})}catch{console.log("Share cancelled or failed")}else a()};return e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:a,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:t?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-green-600",children:"Copied!"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"w-4 h-4"}),e.jsx("span",{children:"Copy"})]})}),e.jsxs("button",{onClick:o,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:[e.jsx(Te,{className:"w-4 h-4"}),e.jsx("span",{children:"Share"})]}),r&&e.jsxs("button",{onClick:r,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:"Open App"})]})]})},We=({error:s,onRetry:r})=>e.jsx("div",{className:"rounded-lg bg-red-50 border border-red-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(we,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-red-900",children:"Something went wrong"}),e.jsx("p",{className:"text-sm text-red-700",children:s}),r&&e.jsxs("button",{onClick:r,className:"flex items-center gap-2 px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-md text-sm font-medium transition-colors",children:[e.jsx($e,{className:"w-4 h-4"}),"Try Again"]})]})]})}),He=()=>e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(Le,{className:"w-8 h-8 text-primary-600"})}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Select Text to Get Started"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6 max-w-sm",children:"Highlight any text on this page and we'll explain it simply."}),e.jsxs("div",{className:"space-y-3 w-full max-w-xs",children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-primary-600 font-bold",children:"1"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Select Text"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Highlight any text on the page"})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-primary-600 font-bold",children:"2"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Right-Click"}),e.jsx("p",{className:"text-xs text-gray-500",children:'Choose "Simplify with Stupify"'})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(je,{className:"w-4 h-4 text-primary-600"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Or Use Shortcut"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Cmd+Shift+S"})," ","(Mac) or"," ",e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Ctrl+Shift+S"})," ","(Windows)"]})]})]})})]})]}),qe={},z=s=>{let r;const t=new Set,n=(c,j)=>{const h=typeof c=="function"?c(r):c;if(!Object.is(h,r)){const x=r;r=j??(typeof h!="object"||h===null)?h:Object.assign({},r,h),t.forEach(g=>g(r,x))}},a=()=>r,m={setState:n,getState:a,getInitialState:()=>l,subscribe:c=>(t.add(c),()=>t.delete(c)),destroy:()=>{(qe?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},l=r=s(n,a,m);return m},Be=s=>s?z(s):z;var q={exports:{}},B={},K={exports:{}},G={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var _=y;function Ke(s,r){return s===r&&(s!==0||1/s===1/r)||s!==s&&r!==r}var Ge=typeof Object.is=="function"?Object.is:Ke,Je=_.useState,Xe=_.useEffect,Ye=_.useLayoutEffect,Ze=_.useDebugValue;function et(s,r){var t=r(),n=Je({inst:{value:t,getSnapshot:r}}),a=n[0].inst,o=n[1];return Ye(function(){a.value=t,a.getSnapshot=r,M(a)&&o({inst:a})},[s,t,r]),Xe(function(){return M(a)&&o({inst:a}),s(function(){M(a)&&o({inst:a})})},[s]),Ze(t),t}function M(s){var r=s.getSnapshot;s=s.value;try{var t=r();return!Ge(s,t)}catch{return!0}}function tt(s,r){return r()}var st=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?tt:et;G.useSyncExternalStore=_.useSyncExternalStore!==void 0?_.useSyncExternalStore:st;K.exports=G;var rt=K.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var U=y,nt=rt;function at(s,r){return s===r&&(s!==0||1/s===1/r)||s!==s&&r!==r}var ot=typeof Object.is=="function"?Object.is:at,it=nt.useSyncExternalStore,lt=U.useRef,ct=U.useEffect,dt=U.useMemo,ut=U.useDebugValue;B.useSyncExternalStoreWithSelector=function(s,r,t,n,a){var o=lt(null);if(o.current===null){var i={hasValue:!1,value:null};o.current=i}else i=o.current;o=dt(function(){function m(x){if(!l){if(l=!0,c=x,x=n(x),a!==void 0&&i.hasValue){var g=i.value;if(a(g,x))return j=g}return j=x}if(g=j,ot(c,x))return g;var S=n(x);return a!==void 0&&a(g,S)?(c=x,g):(c=x,j=S)}var l=!1,c,j,h=t===void 0?null:t;return[function(){return m(r())},h===null?void 0:function(){return m(h())}]},[r,t,n,a]);var p=it(s,o[0],o[1]);return ct(function(){i.hasValue=!0,i.value=p},[p]),ut(p),p};q.exports=B;var pt=q.exports;const mt=ce(pt),J={},{useDebugValue:ht}=H,{useSyncExternalStoreWithSelector:xt}=mt;let V=!1;const ft=s=>s;function yt(s,r=ft,t){(J?"production":void 0)!=="production"&&t&&!V&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),V=!0);const n=xt(s.subscribe,s.getState,s.getServerState||s.getInitialState,r,t);return ht(n),n}const Q=s=>{(J?"production":void 0)!=="production"&&typeof s!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const r=typeof s=="function"?Be(s):s,t=(n,a)=>yt(r,n,a);return Object.assign(t,r),t},gt=s=>s?Q(s):Q,wt=gt((s,r)=>({selectedText:null,complexity:"normal",explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[],history:[],isCollapsed:!1,setSelectedText:t=>s({selectedText:t}),setComplexity:t=>s({complexity:t}),startExplanation:()=>s({explanation:{isLoading:!0,isStreaming:!0,response:"",error:null,completed:!1},followUpQuestions:[]}),streamResponse:t=>{const{explanation:n}=r();s({explanation:{...n,isLoading:!1,isStreaming:!0,response:n.response+t}})},completeExplanation:()=>{const{explanation:t,selectedText:n,complexity:a}=r();s({explanation:{...t,isStreaming:!1,completed:!0}}),n&&r().addToHistory({id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,question:n.text,complexity:a,response:t.response,followUps:[],timestamp:Date.now(),url:n.url})},setError:t=>s({explanation:{isLoading:!1,isStreaming:!1,response:"",error:t,completed:!1}}),clearExplanation:()=>s({explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[]}),setFollowUpQuestions:t=>s({followUpQuestions:t}),markFollowUpClicked:t=>{const{followUpQuestions:n}=r();s({followUpQuestions:n.map(a=>a.id===t?{...a,clicked:!0}:a)})},addToHistory:t=>{const{history:n}=r(),a=[t,...n].slice(0,20);s({history:a})},clearHistory:()=>s({history:[]}),toggleCollapse:()=>s(t=>({isCollapsed:!t.isCollapsed}))}));var bt={};const jt=()=>{const{selectedText:s,complexity:r,explanation:t,followUpQuestions:n,isCollapsed:a,setComplexity:o,startExplanation:i,streamResponse:p,completeExplanation:m,setError:l,setFollowUpQuestions:c,markFollowUpClicked:j,toggleCollapse:h,setSelectedText:x}=wt(),[g,S]=y.useState(!1),[$,I]=y.useState(10),[A,k]=y.useState(!1),[w,C]=y.useState(!1),L=y.useRef(null);y.useEffect(()=>{const d=R.subscribe(u=>{var b;S(u.isAuthenticated),k(((b=u.user)==null?void 0:b.subscription_tier)==="premium")});return R.checkAuthStatus(),d},[]),y.useEffect(()=>E.subscribe(u=>{I(u.remaining)}),[]),y.useEffect(()=>de.subscribe(u=>{C(u)}),[]),y.useEffect(()=>{const d=u=>{u.type==="OPEN_SIDE_PANEL"&&console.log("Opening side panel with text:",u.payload)};return chrome.runtime.onMessage.addListener(d),()=>chrome.runtime.onMessage.removeListener(d)},[]);const X=d=>{try{return new URL(d).hostname.replace("www.","")}catch{return"Unknown"}},T=async()=>{if(!s)return;if(!E.canAsk()){l("Daily limit reached! Upgrade for unlimited questions.");return}const d=s.text;i();const u=await O.get(d,r);if(u){console.log("✅ Using cached response");const v=u.answer.split(" ");for(const f of v)p(f+" "),await new Promise(re=>setTimeout(re,30));m(),F(d,u.answer);return}const b=De();L.current=b;try{let v="";await Oe(d,r,[],{signal:b.signal,onToken:f=>{v+=f,p(f)},onComplete:async f=>{m(),await O.add(d,f,r),await E.recordQuestion(),F(d,f)},onError:f=>{l(f.message||"Failed to get explanation"),console.error("❌ Stream error:",f)}})}catch(v){l(v.message||"Failed to get explanation"),console.error("❌ Ask error:",v)}},F=async(d,u)=>{try{const v=(await Me.generate({question:d,answer:u,complexityLevel:r})).map(f=>({id:f.id,question:f.text,category:f.category,clicked:!1}));c(v)}catch(b){console.error("❌ Failed to generate follow-ups:",b)}},Y=()=>{T()},Z=d=>{j(d.id),x({text:d.question,url:(s==null?void 0:s.url)||"",domain:(s==null?void 0:s.domain)||"Follow-up",timestamp:Date.now()}),setTimeout(()=>T(),100)},ee=()=>{L.current&&(L.current.cancel(),L.current=null)},te=async()=>{try{l("null");const d=`${bt.VITE_API_URL||"https://stupify.app"}/login?ref=extension&mode=popup`,u=window.open(d,"Stupify Login","width=450,height=650,menubar=no,toolbar=no,location=no,status=no"),b=setInterval(async()=>{try{u!=null&&u.closed&&(clearInterval(b),(await R.checkAuthStatus()).isAuthenticated?window.location.reload():l("Login cancelled or failed"))}catch(v){clearInterval(b),console.error("Auth check error:",v)}},1e3);setTimeout(()=>{clearInterval(b),u&&!u.closed&&(u.close(),l("Login timeout"))},5*60*1e3)}catch(d){console.error("❌ Login failed:",d),l("Login failed. Please try again.")}},se=()=>{window.open("https://stupify.app/chat","_blank")};return e.jsxs("div",{className:"h-screen flex flex-col bg-gradient-to-br from-primary-50 via-purple-50 to-pink-50",children:[e.jsx("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 shadow-sm",children:e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-primary-600 to-purple-600 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-sm",children:"S"})}),e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:"Stupify"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[w&&e.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium",children:"Offline"}),g?e.jsx("div",{className:"flex items-center gap-2 text-sm",children:e.jsx("span",{className:"text-gray-600",children:A?e.jsx("span",{className:"px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded font-medium text-xs",children:"∞ Premium"}):e.jsxs("span",{className:"text-gray-700 font-medium",children:[$," left"]})})}):e.jsxs("button",{onClick:te,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Login"]})]})]}),e.jsx(Pe,{selected:r,onChange:o,disabled:t.isLoading||t.isStreaming})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"p-6 space-y-6",children:[!s&&e.jsx(He,{}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:e.jsxs("button",{onClick:h,className:"w-full px-4 py-3 flex items-start justify-between gap-3 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex-1 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(ke,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-xs font-medium text-gray-500",children:X(s.url)})]}),e.jsx("p",{className:`text-sm text-gray-700 ${a?"line-clamp-2":""}`,children:s.text})]}),a?e.jsx(xe,{className:"w-5 h-5 text-gray-400 flex-shrink-0"}):e.jsx(ye,{className:"w-5 h-5 text-gray-400 flex-shrink-0"})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6",children:[t.error?e.jsx(We,{error:t.error,onRetry:Y}):t.response||t.isLoading?e.jsx(ze,{text:t.response,isStreaming:t.isStreaming,isLoading:t.isLoading}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("button",{onClick:T,disabled:!E.canAsk(),className:"px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:E.canAsk()?"Explain This":"Daily Limit Reached"}),!E.canAsk()&&e.jsx("button",{onClick:()=>window.open("https://stupify.app/pricing","_blank"),className:"mt-3 text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Upgrade for unlimited questions →"})]}),t.isStreaming&&e.jsx("div",{className:"mt-4 text-center",children:e.jsx("button",{onClick:ee,className:"text-sm text-gray-600 hover:text-gray-800 font-medium",children:"Cancel"})})]}),t.completed&&t.response&&e.jsx(Qe,{response:t.response,onOpenInApp:se}),n.length>0&&e.jsx(Ve,{questions:n,onQuestionClick:Z})]})]})}),e.jsx("div",{className:"flex-shrink-0 bg-white border-t border-gray-200 px-6 py-3",children:e.jsxs("p",{className:"text-xs text-center text-gray-500",children:["Made with 💜 by"," ",e.jsx("a",{href:"https://stupify.app",target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-700 font-medium",children:"Stupify"})]})})]})};ue.createRoot(document.getElementById("root")).render(e.jsx(H.StrictMode,{children:e.jsx(jt,{})}));console.log("✅ Stupify Side Panel loaded");
