const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StatsWidget-pagOTyWU.js","assets/react-vendor-HEOWGPvr.js","assets/utils-CJJeYulS.js","assets/icons-D19DpaoO.js","assets/ActionButtons-Dm50-Ogh.js","assets/FollowUpQuestions-BPVeivTU.js","assets/ErrorState-Bz3fd78Q.js","assets/EmptyState-vUfaVptD.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,s,r)=>((t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r)(t,"symbol"!=typeof s?s+"":s,r);import{j as s,r,R as a,a as n}from"./react-vendor-HEOWGPvr.js";import{L as o,f as i,g as l,h as c,i as d}from"./icons-D19DpaoO.js";import{c as p}from"./store-5ItP4VQq.js";import{b as m,a as u,r as h,c as x}from"./rateLimiter-L6ZkJs0D.js";import"./globals-CZNwFqmC.js";const g=new class{constructor(){t(this,"cache",new Map)}async generate(e){const{question:t,answer:s,complexityLevel:r,conversationContext:a=[]}=e,n=this.getCacheKey(t,r);if(this.cache.has(n))return this.cache.get(n);try{const e=(await m.request("/api/followups/generate",{method:"POST",body:JSON.stringify({question:t,answer:s,complexityLevel:r,conversationContext:a}),requiresAuth:!1})).followUps||[],o=this.validateFollowUps(e,t);if(this.cache.set(n,o),this.cache.size>50){const e=this.cache.keys().next().value;this.cache.delete(e)}return o}catch(o){return this.generateLocal(e)}}generateLocal(e){const{question:t,complexityLevel:s}=e,r=this.extractTopic(t);return this.getTemplates(s).map((e,t)=>({id:`local-${Date.now()}-${t}`,text:e.replace("{topic}",r),category:["deeper","related","practical"][t]||"related"}))}getTemplates(e){const t={"5yo":["Why is {topic} important?","What else works like {topic}?","Can you show me {topic} with a picture?"],normal:["How does {topic} actually work?","What are some real-world examples of {topic}?","What are the limitations of {topic}?"],advanced:["What are the technical details of {topic}?","How does {topic} compare to alternatives?","What are the edge cases of {topic}?"]};return t[e]||t.normal}extractTopic(e){const t=e.toLowerCase().replace(/^(what|how|why|when|where|who|can you|could you|please|explain|tell me about)\s+/gi,"").replace(/[?.!,]/g,"").trim().split(" ");return t.slice(0,Math.min(4,t.length)).join(" ")}validateFollowUps(e,t){const s=[],r=new Set;for(const a of e){if(!this.isValidFollowUp(a,t))continue;const e=a.text.toLowerCase().trim();if(!r.has(e)&&(r.add(e),s.push(a),s.length>=3))break}return s}isValidFollowUp(e,t){const s=e.text.trim();if(s.length<10||s.length>150)return!1;return!(this.calculateSimilarity(s,t)>.8)&&(!!this.isQuestion(s)&&!!["deeper","related","practical"].includes(e.category))}isQuestion(e){return e.endsWith("?")||/^(what|how|why|when|where|who|can|could|would|should|is|are|do|does)/i.test(e)}calculateSimilarity(e,t){const s=new Set(e.toLowerCase().split(/\s+/)),r=new Set(t.toLowerCase().split(/\s+/)),a=new Set([...s].filter(e=>r.has(e))),n=new Set([...s,...r]);return a.size/n.size}getCacheKey(e,t){return`${e.toLowerCase().trim()}-${t}`}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}assignCategories(e){return e.map((e,t)=>{const s=this.inferCategory(e,t);return{id:`generated-${Date.now()}-${t}`,text:e,category:s}})}inferCategory(e,t){const s=e.toLowerCase();if(s.includes("why")||s.includes("how does")||s.includes("explain more")||s.includes("detail"))return"deeper";if(s.includes("example")||s.includes("use")||s.includes("apply")||s.includes("real world")||s.includes("practice"))return"practical";if(s.includes("similar")||s.includes("related")||s.includes("other")||s.includes("compare"))return"related";return["deeper","related","practical"][t%3]}};var y={};async function f(e,t,s=[],r){const{onToken:a,onComplete:n,onError:o,signal:i}=r;let l="",c=null;try{const r=await m.getAccessToken();if(!r)throw new Error("Not authenticated");c=new AbortController,i&&i.addEventListener("abort",()=>{null==c||c.abort()});const o=[...s,{role:"user",content:e}],p=await fetch(`${y.VITE_API_URL||"https://stupify.app"}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({messages:o,simplicityLevel:t,source:"extension"}),signal:c.signal});if(!p.ok){const e=await p.json();throw new Error(e.error||e.message||"Chat request failed")}if(!p.body)throw new Error("No response body");const u=p.body.getReader(),h=new TextDecoder;for(;;){const{done:e,value:t}=await u.read();if(e)break;const s=h.decode(t,{stream:!0}).split("\n").filter(e=>e.trim());for(const r of s)try{if(!r.trim())continue;let e=r;if(r.includes(":")){e=r.split(":").slice(1).join(":")}try{const t=JSON.parse(e);t.content?e=t.content:"string"==typeof t&&(e=t)}catch{}e&&e.trim()&&(a(e),l+=e)}catch(d){}}n(l)}catch(p){if(p instanceof Error&&"AbortError"===p.name)return;o(p)}}function w(){const e=new AbortController;return{signal:e.signal,cancel:()=>e.abort()}}async function b(e,t,s=[],r,a=2){let n=null;for(let i=0;i<a;i++)try{return void(await f(e,t,s,r))}catch(o){if(n=o,n.message.includes("authenticated")||"AbortError"===n.name)throw n;if(i<a-1){const e=Math.min(1e3*Math.pow(2,i),3e3);await new Promise(t=>setTimeout(t,e))}}throw n||new Error("Stream failed after retries")}const j={},v=function(e,t,s){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),s=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));r=Promise.allSettled(t.map(e=>{if((e=function(e){return"/"+e}(e))in j)return;j[e]=!0;const t=e.endsWith(".css"),r=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${r}`))return;const a=document.createElement("link");return a.rel=t?"stylesheet":"modulepreload",t||(a.as="script"),a.crossOrigin="",a.href=e,s&&a.setAttribute("nonce",s),document.head.appendChild(a),t?new Promise((t,s)=>{a.addEventListener("load",t),a.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})},N={"5yo":{label:"5yo",description:"Like I'm 5",emoji:"ðŸ§¸",color:"bg-pink-500 hover:bg-pink-600",selectedColor:"bg-pink-600 ring-pink-500"},normal:{label:"Normal",description:"Balanced",emoji:"âš–ï¸",color:"bg-primary-500 hover:bg-primary-600",selectedColor:"bg-primary-600 ring-primary-500"},advanced:{label:"Advanced",description:"Technical",emoji:"ðŸ§ ",color:"bg-purple-600 hover:bg-purple-700",selectedColor:"bg-purple-700 ring-purple-500"}},E=({selected:e,onChange:t,disabled:r=!1})=>s.jsx("div",{className:"flex gap-2",children:Object.keys(N).map(a=>{const n=N[a],o=e===a;return s.jsx("button",{onClick:()=>t(a),disabled:r,className:`\n              flex-1 px-3 py-2.5 rounded-lg font-medium text-sm\n              transition-all duration-200\n              disabled:opacity-50 disabled:cursor-not-allowed\n              ${o?`${n.selectedColor} text-white ring-2 ring-offset-2 shadow-md`:"bg-white text-gray-700 hover:bg-gray-50 border border-gray-200"}\n            `,children:s.jsxs("div",{className:"flex flex-col items-center gap-1",children:[s.jsx("span",{className:"text-lg",children:n.emoji}),s.jsx("span",{className:"font-semibold",children:n.label}),s.jsx("span",{className:"text-xs opacity-75",children:n.description})]})},a)})}),k=({text:e,isStreaming:t,isLoading:a})=>{const n=r.useRef(null);return r.useEffect(()=>{t&&n.current&&n.current.scrollIntoView({behavior:"smooth"})},[e,t]),a&&!e?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsxs("div",{className:"text-center space-y-3",children:[s.jsx(o,{className:"w-8 h-8 text-primary-600 animate-spin mx-auto"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Thinking..."})]})}):e?s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"prose prose-sm max-w-none",children:s.jsxs("div",{className:"text-gray-800 leading-relaxed whitespace-pre-wrap",children:[e,t&&s.jsx("span",{className:"inline-block w-0.5 h-4 ml-1 bg-primary-600 animate-pulse"})]})}),s.jsx("div",{ref:n})]}):null},C=p((e,t)=>({selectedText:null,complexity:"normal",explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[],history:[],isCollapsed:!1,setSelectedText:t=>e({selectedText:t}),setComplexity:t=>e({complexity:t}),startExplanation:()=>e({explanation:{isLoading:!0,isStreaming:!0,response:"",error:null,completed:!1},followUpQuestions:[]}),streamResponse:s=>{const{explanation:r}=t();e({explanation:{...r,isLoading:!1,isStreaming:!0,response:r.response+s}})},completeExplanation:()=>{const{explanation:s,selectedText:r,complexity:a}=t();e({explanation:{...s,isStreaming:!1,completed:!0}}),r&&t().addToHistory({id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,question:r.text,complexity:a,response:s.response,followUps:[],timestamp:Date.now(),url:r.url})},setError:t=>e({explanation:{isLoading:!1,isStreaming:!1,response:"",error:t,completed:!1}}),clearExplanation:()=>e({explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[]}),setFollowUpQuestions:t=>e({followUpQuestions:t}),markFollowUpClicked:s=>{const{followUpQuestions:r}=t();e({followUpQuestions:r.map(e=>e.id===s?{...e,clicked:!0}:e)})},addToHistory:s=>{const{history:r}=t(),a=[s,...r].slice(0,20);e({history:a})},clearHistory:()=>e({history:[]}),toggleCollapse:()=>e(e=>({isCollapsed:!e.isCollapsed}))})),S=({size:e="medium",message:t="Loading..."})=>s.jsx("div",{className:"flex items-center justify-center p-8",children:s.jsxs("div",{className:"text-center space-y-3",children:[s.jsx("div",{className:`${{small:"h-4 w-4",medium:"h-8 w-8",large:"h-12 w-12"}[e]} border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto`}),s.jsx("p",{className:"text-sm text-gray-600",children:t})]})});class L extends a.Component{constructor(e){super(e),t(this,"retry",()=>{this.setState({hasError:!1,error:null})}),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){}render(){if(this.state.hasError){const e=this.props.fallback||_;return s.jsx(e,{error:this.state.error,retry:this.retry})}return this.props.children}}const _=({error:e,retry:t})=>s.jsx("div",{className:"flex items-center justify-center p-8",children:s.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[s.jsx("div",{className:"text-red-500 text-4xl",children:"âš ï¸"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Failed to load component"}),s.jsx("p",{className:"text-sm text-gray-600",children:e.message}),s.jsx("button",{onClick:t,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:"Try Again"})]})});function T(e,t={}){const a=function(e,t={}){const{maxRetries:s=3,retryDelay:a=1e3}=t;return r.lazy(()=>new Promise((t,r)=>{const n=(o=1)=>{e().then(t).catch(e=>{o>=s?r(e):setTimeout(()=>n(o+1),a*o)})};n()}))}(e,t.retry),n=t.loading||S,o=t.error;return e=>s.jsx(L,{fallback:o,children:s.jsx(r.Suspense,{fallback:s.jsx(n,{}),children:s.jsx(a,{...e})})})}function A(e){e().catch(e=>{})}var U={};const P=T(()=>v(()=>import("./StatsWidget-pagOTyWU.js"),__vite__mapDeps([0,1,2,3])),{loading:()=>s.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6",children:s.jsxs("div",{className:"animate-pulse space-y-3",children:[s.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/3"}),s.jsx("div",{className:"h-8 bg-gray-200 rounded"})]})})}),R=T(()=>v(()=>import("./ActionButtons-Dm50-Ogh.js"),__vite__mapDeps([4,1,3]))),D=T(()=>v(()=>import("./FollowUpQuestions-BPVeivTU.js"),__vite__mapDeps([5,1,3]))),I=T(()=>v(()=>import("./ErrorState-Bz3fd78Q.js"),__vite__mapDeps([6,1,3]))),F=T(()=>v(()=>import("./EmptyState-vUfaVptD.js"),__vite__mapDeps([7,1,3]))),O=()=>{const{selectedText:e,complexity:t,explanation:a,followUpQuestions:n,isCollapsed:o,setComplexity:p,startExplanation:m,streamResponse:y,completeExplanation:f,setError:j,setFollowUpQuestions:N,markFollowUpClicked:S,toggleCollapse:L,setSelectedText:_}=C(),[T,O]=r.useState(!1),[$,q]=r.useState(10),[Q,V]=r.useState(!1),[M,W]=r.useState(!1),z=r.useRef(null);r.useEffect(()=>{const e=u.subscribe(e=>{var t;O(e.isAuthenticated),V("premium"===(null==(t=e.user)?void 0:t.subscription_tier))});return u.checkAuthStatus(),e},[]),r.useEffect(()=>h.subscribe(e=>{q(e.remaining)}),[]),r.useEffect(()=>{W(!1)},[]),r.useEffect(()=>{const e=e=>{e.type};return chrome.runtime.onMessage.addListener(e),()=>chrome.runtime.onMessage.removeListener(e)},[]);const B=async()=>{if(!e)return;if(!h.canAsk())return void j("Daily limit reached! Upgrade for unlimited questions.");const s=e.text;m();const r=await x.get(s,t);if(r){const e=r.answer.split(" ");for(const t of e)y(t+" "),await new Promise(e=>setTimeout(e,30));return f(),void H(s,r.answer)}const a=w();z.current=a;try{let e="";await b(s,t,[],{signal:a.signal,onToken:t=>{e+=t,y(t)},onComplete:async e=>{f(),await x.add(s,e,t),await h.recordQuestion(),H(s,e)},onError:e=>{j(e.message||"Failed to get explanation")}})}catch(n){j(n.message||"Failed to get explanation")}};r.useEffect(()=>{(async()=>{try{const{pendingExplanation:e}=await chrome.storage.local.get("pendingExplanation");if(null==e?void 0:e.text){const s=e.text;_(s),await chrome.storage.local.remove("pendingExplanation"),setTimeout(async()=>{if(h.canAsk()){m();try{const e=w();z.current=e,await b(s,t,[],{onToken:e=>y(e),onComplete:()=>{f(),z.current=null},onError:e=>{j(e.message),z.current=null},signal:e.signal},2)}catch(e){j(e.message||"Failed to get explanation")}}else j("Daily limit reached! Upgrade for unlimited questions.")},500)}}catch(e){}})()},[]);const H=async(e,s)=>{try{const r=(await g.generate({question:e,answer:s,complexityLevel:t})).map(e=>({id:e.id,question:e.text,category:e.category,clicked:!1}));N(r)}catch(r){}};return s.jsxs("div",{className:"h-screen flex flex-col bg-gradient-to-br from-primary-50 via-purple-50 to-pink-50",children:[s.jsx("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 shadow-sm",children:s.jsxs("div",{className:"px-6 py-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-primary-600 to-purple-600 rounded-lg flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-sm",children:"S"})}),s.jsx("h1",{className:"text-lg font-bold text-gray-900",children:"Stupify"})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[M&&s.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium",children:"Offline"}),T?s.jsx("div",{className:"flex items-center gap-2 text-sm",children:s.jsx("span",{className:"text-gray-600",children:Q?s.jsx("span",{className:"px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded font-medium text-xs",children:"âˆž Premium"}):s.jsxs("span",{className:"text-gray-700 font-medium",children:[$," left"]})})}):s.jsxs("button",{onClick:async()=>{try{j("null");const e=`${U.VITE_API_URL||"https://stupify.app"}/login?ref=extension&mode=popup`,t=window.open(e,"Stupify Login","width=450,height=650,menubar=no,toolbar=no,location=no,status=no"),s=setInterval(async()=>{try{if(null==t?void 0:t.closed){clearInterval(s);(await u.checkAuthStatus()).isAuthenticated?window.location.reload():j("Login cancelled or failed")}}catch(e){clearInterval(s)}},1e3);setTimeout(()=>{clearInterval(s),t&&!t.closed&&(t.close(),j("Login timeout"))},3e5)}catch(e){j("Login failed. Please try again.")}},className:"flex items-center gap-1.5 px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[s.jsx(i,{className:"w-4 h-4"}),"Login"]})]})]}),s.jsx(E,{selected:t,onChange:p,disabled:a.isLoading||a.isStreaming})]})}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsxs("div",{className:"p-6 space-y-6",children:[s.jsx(P,{}),!e&&s.jsx(F,{}),e&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:s.jsxs("button",{onClick:L,className:"w-full px-4 py-3 flex items-start justify-between gap-3 hover:bg-gray-50 transition-colors",children:[s.jsxs("div",{className:"flex-1 text-left",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx(l,{className:"w-4 h-4 text-gray-400"}),s.jsx("span",{className:"text-xs font-medium text-gray-500",children:(e=>{try{return new URL(e).hostname.replace("www.","")}catch{return"Unknown"}})(e.url)})]}),s.jsx("p",{className:"text-sm text-gray-700 "+(o?"line-clamp-2":""),children:e.text})]}),o?s.jsx(c,{className:"w-5 h-5 text-gray-400 flex-shrink-0"}):s.jsx(d,{className:"w-5 h-5 text-gray-400 flex-shrink-0"})]})}),s.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6",onMouseEnter:()=>{A(()=>v(()=>import("./ActionButtons-Dm50-Ogh.js"),__vite__mapDeps([4,1,3])))},children:[a.error?s.jsx(I,{error:a.error,onRetry:()=>{B()}}):a.response||a.isLoading?s.jsx(k,{text:a.response,isStreaming:a.isStreaming,isLoading:a.isLoading}):s.jsxs("div",{className:"text-center py-8",children:[s.jsx("button",{onClick:B,onMouseEnter:()=>{A(()=>v(()=>import("./FollowUpQuestions-BPVeivTU.js"),__vite__mapDeps([5,1,3])))},"data-testid":"explain-button",disabled:!h.canAsk(),className:"px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:h.canAsk()?"Explain This":"Daily Limit Reached"}),!h.canAsk()&&s.jsx("button",{onClick:()=>window.open("https://stupify.app/pricing","_blank"),className:"mt-3 text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Upgrade for unlimited questions â†’"})]}),a.isStreaming&&s.jsx("div",{className:"mt-4 text-center",children:s.jsx("button",{onClick:()=>{z.current&&(z.current.cancel(),z.current=null)},className:"text-sm text-gray-600 hover:text-gray-800 font-medium",children:"Cancel"})})]}),a.completed&&a.response&&s.jsx(R,{response:a.response,onOpenInApp:()=>{window.open("https://stupify.app/chat","_blank")}}),n.length>0&&s.jsx(D,{questions:n,onQuestionClick:t=>{S(t.id),_({text:t.question,url:(null==e?void 0:e.url)||"",domain:(null==e?void 0:e.domain)||"Follow-up",timestamp:Date.now()}),setTimeout(()=>B(),100)}})]})]})}),s.jsx("div",{className:"flex-shrink-0 bg-white border-t border-gray-200 px-6 py-3",children:s.jsxs("p",{className:"text-xs text-center text-gray-500",children:["Made with ðŸ’œ by"," ",s.jsx("a",{href:"https://stupify.app",target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-700 font-medium",children:"Stupify"})]})})]})};n.createRoot(document.getElementById("root")).render(s.jsx(a.StrictMode,{children:s.jsx(O,{})}));
