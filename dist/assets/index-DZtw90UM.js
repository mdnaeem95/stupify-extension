var Z=Object.defineProperty;var ee=(i,e,t)=>e in i?Z(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var p=(i,e,t)=>ee(i,typeof e!="symbol"?e+"":e,t);import{c as w,j as s,r as x,S as te,E as se,a as re,R as ae,b as ie}from"./globals-DrID7SY-.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],oe=w("check",ne);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],le=w("chevron-down",ce);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],de=w("chevron-up",he);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],me=w("circle-alert",ue);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3",key:"11bfej"}]],ge=w("command",pe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],ye=w("copy",fe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],we=w("globe",xe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],be=w("loader-circle",ke);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]],ve=w("log-in",Se);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M14 4.1 12 6",key:"ita8i4"}],["path",{d:"m5.1 8-2.9-.8",key:"1go3kf"}],["path",{d:"m6 12-1.9 2",key:"mnht97"}],["path",{d:"M7.2 2.2 8 5.1",key:"1cfko1"}],["path",{d:"M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z",key:"s0h3yz"}]],Ne=w("mouse-pointer-click",je);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Te=w("refresh-cw",Ce);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Ae=w("share-2",_e),q={"5yo":{label:"5yo",description:"Like I'm 5",emoji:"🧸",color:"bg-pink-500 hover:bg-pink-600",selectedColor:"bg-pink-600 ring-pink-500"},normal:{label:"Normal",description:"Balanced",emoji:"⚖️",color:"bg-primary-500 hover:bg-primary-600",selectedColor:"bg-primary-600 ring-primary-500"},advanced:{label:"Advanced",description:"Technical",emoji:"🧠",color:"bg-purple-600 hover:bg-purple-700",selectedColor:"bg-purple-700 ring-purple-500"}},Ee=({selected:i,onChange:e,disabled:t=!1})=>s.jsx("div",{className:"flex gap-2",children:Object.keys(q).map(r=>{const a=q[r],n=i===r;return s.jsx("button",{onClick:()=>e(r),disabled:t,className:`
              flex-1 px-3 py-2.5 rounded-lg font-medium text-sm
              transition-all duration-200
              disabled:opacity-50 disabled:cursor-not-allowed
              ${n?`${a.selectedColor} text-white ring-2 ring-offset-2 shadow-md`:"bg-white text-gray-700 hover:bg-gray-50 border border-gray-200"}
            `,children:s.jsxs("div",{className:"flex flex-col items-center gap-1",children:[s.jsx("span",{className:"text-lg",children:a.emoji}),s.jsx("span",{className:"font-semibold",children:a.label}),s.jsx("span",{className:"text-xs opacity-75",children:a.description})]})},r)})}),Ue=({text:i,isStreaming:e,isLoading:t})=>{const r=x.useRef(null);return x.useEffect(()=>{e&&r.current&&r.current.scrollIntoView({behavior:"smooth"})},[i,e]),t&&!i?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsxs("div",{className:"text-center space-y-3",children:[s.jsx(be,{className:"w-8 h-8 text-primary-600 animate-spin mx-auto"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Thinking..."})]})}):i?s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"prose prose-sm max-w-none",children:s.jsxs("div",{className:"text-gray-800 leading-relaxed whitespace-pre-wrap",children:[i,e&&s.jsx("span",{className:"inline-block w-0.5 h-4 ml-1 bg-primary-600 animate-pulse"})]})}),s.jsx("div",{ref:r})]}):null},Le=({questions:i,onQuestionClick:e})=>i.length===0?null:s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(te,{className:"w-4 h-4 text-primary-600"}),s.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Keep Learning"})]}),s.jsx("div",{className:"space-y-2",children:i.map(t=>s.jsx("button",{onClick:()=>e(t),disabled:t.clicked,className:`
              w-full text-left px-4 py-3 rounded-lg
              transition-all duration-200
              ${t.clicked?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-primary-50 border border-gray-200 hover:border-primary-300 text-gray-700 hover:text-primary-700"}
            `,children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("span",{className:"text-primary-500 mt-0.5",children:"→"}),s.jsx("span",{className:"text-sm",children:t.question})]})},t.id))})]}),Ie=({response:i,onOpenInApp:e})=>{const[t,r]=x.useState(!1),a=async()=>{try{await navigator.clipboard.writeText(i),r(!0),setTimeout(()=>r(!1),2e3)}catch(o){console.error("Failed to copy:",o)}},n=async()=>{if(navigator.share)try{await navigator.share({title:"Stupify Explanation",text:i})}catch{console.log("Share cancelled or failed")}else a()};return s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:a,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:t?s.jsxs(s.Fragment,{children:[s.jsx(oe,{className:"w-4 h-4 text-green-600"}),s.jsx("span",{className:"text-green-600",children:"Copied!"})]}):s.jsxs(s.Fragment,{children:[s.jsx(ye,{className:"w-4 h-4"}),s.jsx("span",{children:"Copy"})]})}),s.jsxs("button",{onClick:n,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:[s.jsx(Ae,{className:"w-4 h-4"}),s.jsx("span",{children:"Share"})]}),e&&s.jsxs("button",{onClick:e,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors",children:[s.jsx(se,{className:"w-4 h-4"}),s.jsx("span",{children:"Open App"})]})]})},Pe=({error:i,onRetry:e})=>s.jsx("div",{className:"rounded-lg bg-red-50 border border-red-200 p-4",children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx(me,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),s.jsxs("div",{className:"flex-1 space-y-2",children:[s.jsx("p",{className:"text-sm font-medium text-red-900",children:"Something went wrong"}),s.jsx("p",{className:"text-sm text-red-700",children:i}),e&&s.jsxs("button",{onClick:e,className:"flex items-center gap-2 px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-md text-sm font-medium transition-colors",children:[s.jsx(Te,{className:"w-4 h-4"}),"Try Again"]})]})]})}),Me=()=>s.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(Ne,{className:"w-8 h-8 text-primary-600"})}),s.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Select Text to Get Started"}),s.jsx("p",{className:"text-sm text-gray-600 mb-6 max-w-sm",children:"Highlight any text on this page and we'll explain it simply."}),s.jsxs("div",{className:"space-y-3 w-full max-w-xs",children:[s.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:s.jsx("span",{className:"text-primary-600 font-bold",children:"1"})}),s.jsxs("div",{className:"text-left",children:[s.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Select Text"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Highlight any text on the page"})]})]})}),s.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:s.jsx("span",{className:"text-primary-600 font-bold",children:"2"})}),s.jsxs("div",{className:"text-left",children:[s.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Right-Click"}),s.jsx("p",{className:"text-xs text-gray-500",children:'Choose "Simplify with Stupify"'})]})]})}),s.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:s.jsx(ge,{className:"w-4 h-4 text-primary-600"})}),s.jsxs("div",{className:"text-left",children:[s.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Or Use Shortcut"}),s.jsxs("p",{className:"text-xs text-gray-500",children:[s.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Cmd+Shift+S"})," ","(Mac) or"," ",s.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Ctrl+Shift+S"})," ","(Windows)"]})]})]})})]})]}),Oe=re((i,e)=>({selectedText:null,complexity:"normal",explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[],history:[],isCollapsed:!1,setSelectedText:t=>i({selectedText:t}),setComplexity:t=>i({complexity:t}),startExplanation:()=>i({explanation:{isLoading:!0,isStreaming:!0,response:"",error:null,completed:!1},followUpQuestions:[]}),streamResponse:t=>{const{explanation:r}=e();i({explanation:{...r,isLoading:!1,isStreaming:!0,response:r.response+t}})},completeExplanation:()=>{const{explanation:t,selectedText:r,complexity:a}=e();i({explanation:{...t,isStreaming:!1,completed:!0}}),r&&e().addToHistory({id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,question:r.text,complexity:a,response:t.response,followUps:[],timestamp:Date.now(),url:r.url})},setError:t=>i({explanation:{isLoading:!1,isStreaming:!1,response:"",error:t,completed:!1}}),clearExplanation:()=>i({explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[]}),setFollowUpQuestions:t=>i({followUpQuestions:t}),markFollowUpClicked:t=>{const{followUpQuestions:r}=e();i({followUpQuestions:r.map(a=>a.id===t?{...a,clicked:!0}:a)})},addToHistory:t=>{const{history:r}=e(),a=[t,...r].slice(0,20);i({history:a})},clearHistory:()=>i({history:[]}),toggleCollapse:()=>i(t=>({isCollapsed:!t.isCollapsed}))}));var z={};const Re=z.VITE_API_URL||"https://stupify.ai",L=z.VITE_SUPABASE_URL,I=z.VITE_SUPABASE_ANON_KEY;class $e{constructor(){p(this,"accessToken",null);p(this,"refreshToken",null);p(this,"isRefreshing",!1);p(this,"refreshPromise",null);this.loadTokens()}async loadTokens(){try{const e=await chrome.storage.local.get(["accessToken","refreshToken"]);this.accessToken=e.accessToken||null,this.refreshToken=e.refreshToken||null}catch(e){console.error("❌ Failed to load tokens:",e)}}async saveTokens(e,t){this.accessToken=e,this.refreshToken=t,await chrome.storage.local.set({accessToken:e,refreshToken:t})}async clearTokens(){this.accessToken=null,this.refreshToken=null,await chrome.storage.local.remove(["accessToken","refreshToken","user"])}async getAccessToken(){return this.accessToken||await this.loadTokens(),this.accessToken}async refreshAccessToken(){return this.isRefreshing&&this.refreshPromise?this.refreshPromise:(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch(`${L}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:I},body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok)throw new Error("Failed to refresh token");const t=await e.json();if(t.access_token&&t.refresh_token)await this.saveTokens(t.access_token,t.refresh_token);else throw new Error("Invalid token response")}catch(e){throw console.error("❌ Token refresh failed:",e),await this.clearTokens(),e}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),this.refreshPromise)}async request(e,t={}){const{requiresAuth:r=!0,retries:a=3,timeout:n=3e4,...o}=t;let l=null;for(let d=0;d<a;d++)try{const c=new Headers(o.headers);if(c.set("Content-Type","application/json"),r){const k=await this.getAccessToken();if(!k)throw new Error("Not authenticated");c.set("Authorization",`Bearer ${k}`)}const u=new AbortController,C=setTimeout(()=>u.abort(),n),f=await fetch(`${Re}${e}`,{...o,headers:c,signal:u.signal});if(clearTimeout(C),f.status===401&&r&&d<a-1){console.log("🔄 Token expired, refreshing..."),await this.refreshAccessToken();continue}if(!f.ok){const k={message:`Request failed: ${f.statusText}`,status:f.status};try{const S=await f.json();k.message=S.error||S.message||k.message,k.code=S.code}catch{}throw k}return await f.json()}catch(c){if(l=c,c.status===401||c.status===403)throw c;if(c instanceof Error&&c.name==="AbortError")throw new Error("Request timeout");if(d<a-1){const u=Math.min(1e3*Math.pow(2,d),5e3);await new Promise(C=>setTimeout(C,u))}}throw l||new Error("Request failed")}async login(e,t){const r=await fetch(`${L}/auth/v1/token?grant_type=password`,{method:"POST",headers:{"Content-Type":"application/json",apikey:I},body:JSON.stringify({email:e,password:t})});if(!r.ok){const n=await r.json();throw new Error(n.error_description||n.message||"Login failed")}const a=await r.json();if(!a.access_token||!a.refresh_token)throw new Error("Invalid login response");await this.saveTokens(a.access_token,a.refresh_token),a.user&&await chrome.storage.local.set({user:a.user})}async signup(e,t){const r=await fetch(`${L}/auth/v1/signup`,{method:"POST",headers:{"Content-Type":"application/json",apikey:I},body:JSON.stringify({email:e,password:t})});if(!r.ok){const n=await r.json();throw new Error(n.error_description||n.message||"Signup failed")}const a=await r.json();if(!a.access_token||!a.refresh_token)throw new Error("Invalid signup response");await this.saveTokens(a.access_token,a.refresh_token),a.user&&await chrome.storage.local.set({user:a.user})}async logout(){try{this.accessToken&&await fetch(`${L}/auth/v1/logout`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,apikey:I}})}catch(e){console.error("❌ Logout error:",e)}finally{await this.clearTokens()}}async getUser(){return(await chrome.storage.local.get(["user"])).user||null}async isAuthenticated(){return!!await this.getAccessToken()}async checkUsage(){return this.request("/api/usage",{requiresAuth:!0})}async getProfile(){return this.request("/api/user/profile",{requiresAuth:!0})}}const b=new $e;var H={};class ze{constructor(){p(this,"listeners",new Set);p(this,"currentState",{isAuthenticated:!1,user:null,loading:!0});this.initialize()}async initialize(){await this.checkAuthStatus(),chrome.runtime.onMessage.addListener((e,t,r)=>{e.type==="AUTH_STATE_CHANGED"&&(console.log(t,r),this.checkAuthStatus())})}async checkAuthStatus(){try{const e=await b.isAuthenticated(),t=e?await b.getUser():null;return this.updateState({isAuthenticated:e,user:t,loading:!1}),this.currentState}catch(e){return console.error("❌ Auth check failed:",e),this.updateState({isAuthenticated:!1,user:null,loading:!1}),this.currentState}}async login(e,t){try{this.updateState({...this.currentState,loading:!0}),await b.login(e,t);const r=await b.getUser();this.updateState({isAuthenticated:!0,user:r,loading:!1}),this.broadcastAuthChange(),this.trackEvent("extension_login",{method:"email"})}catch(r){throw this.updateState({isAuthenticated:!1,user:null,loading:!1}),r}}async signup(e,t){try{this.updateState({...this.currentState,loading:!0}),await b.signup(e,t);const r=await b.getUser();this.updateState({isAuthenticated:!0,user:r,loading:!1}),this.broadcastAuthChange(),this.trackEvent("extension_signup",{method:"email"})}catch(r){throw this.updateState({isAuthenticated:!1,user:null,loading:!1}),r}}async logout(){try{await b.logout(),this.updateState({isAuthenticated:!1,user:null,loading:!1}),await chrome.storage.local.remove(["cachedExplanations","lastSync"]),this.broadcastAuthChange(),this.trackEvent("extension_logout")}catch(e){throw console.error("❌ Logout error:",e),e}}async loginWithWebApp(){const e=await chrome.tabs.create({url:`${H.VITE_API_URL||"https://stupify.ai"}/login?redirect=extension`});return new Promise((t,r)=>{const a=async n=>{n.type==="WEB_AUTH_COMPLETE"&&n.tabId===e.id&&(chrome.runtime.onMessage.removeListener(a),await this.checkAuthStatus(),this.currentState.isAuthenticated?t():r(new Error("Authentication failed")))};chrome.runtime.onMessage.addListener(a),setTimeout(()=>{chrome.runtime.onMessage.removeListener(a),r(new Error("Authentication timeout"))},5*60*1e3)})}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}updateState(e){this.currentState=e,this.listeners.forEach(t=>{try{t(e)}catch(r){console.error("❌ Auth listener error:",r)}})}broadcastAuthChange(){chrome.runtime.sendMessage({type:"AUTH_STATE_CHANGED",payload:this.currentState}).catch(()=>{})}trackEvent(e,t){chrome.runtime.sendMessage({type:"TRACK_EVENT",payload:{event:e,properties:{...t,timestamp:Date.now()}}}).catch(()=>{})}async syncWithWebApp(){try{const e=await chrome.tabs.query({url:`${H.VITE_API_URL||"https://stupify.ai"}/*`});if(e.length===0)return;for(const t of e)if(t.id)try{const r=await chrome.tabs.sendMessage(t.id,{type:"GET_AUTH_STATE"});if(r&&r.isAuthenticated){await chrome.storage.local.set({accessToken:r.accessToken,refreshToken:r.refreshToken,user:r.user}),await this.checkAuthStatus();break}}catch{}}catch(e){console.error("❌ Sync error:",e)}}isPremium(){var e;return((e=this.currentState.user)==null?void 0:e.subscription_tier)==="premium"}getUserEmail(){var e;return((e=this.currentState.user)==null?void 0:e.email)||null}getUserId(){var e;return((e=this.currentState.user)==null?void 0:e.id)||null}}const A=new ze,P="cachedExplanations",B=10,Fe=7*24*60*60*1e3;class De{constructor(){p(this,"cache",[]);p(this,"initialized",!1);this.initialize()}async initialize(){try{await this.loadCache(),this.initialized=!0}catch(e){console.error("❌ Cache initialization failed:",e)}}async loadCache(){try{const e=await chrome.storage.local.get([P]);this.cache=e[P]||[],this.cleanExpiredItems()}catch(e){console.error("❌ Failed to load cache:",e),this.cache=[]}}async saveCache(){try{await chrome.storage.local.set({[P]:this.cache})}catch(e){console.error("❌ Failed to save cache:",e)}}async add(e,t,r){this.initialized||await this.initialize();const a={question:e.trim().toLowerCase(),answer:t,complexity_level:r,cached_at:Date.now()};this.cache=this.cache.filter(n=>!(n.question===a.question&&n.complexity_level===a.complexity_level)),this.cache.unshift(a),this.cache.length>B&&(this.cache=this.cache.slice(0,B)),await this.saveCache()}async get(e,t){this.initialized||await this.initialize();const r=e.trim().toLowerCase(),a=this.cache.find(o=>o.question===r&&o.complexity_level===t);return a&&!this.isExpired(a)?a:this.cache.find(o=>o.complexity_level===t&&!this.isExpired(o)&&this.isSimilar(r,o.question))||null}isExpired(e){return Date.now()-e.cached_at>Fe}isSimilar(e,t){const r=new Set(e.split(" ").filter(l=>l.length>3)),a=new Set(t.split(" ").filter(l=>l.length>3));return r.size===0||a.size===0?!1:new Set([...r].filter(l=>a.has(l))).size/Math.min(r.size,a.size)>.6}cleanExpiredItems(){const e=this.cache.length;this.cache=this.cache.filter(t=>!this.isExpired(t)),this.cache.length<e&&this.saveCache()}async clear(){this.cache=[],await chrome.storage.local.remove([P])}getSize(){return this.cache.length}getAll(){return[...this.cache]}getStats(){const e=Date.now(),t={total:this.cache.length,expired:this.cache.filter(a=>this.isExpired(a)).length,byLevel:{"5yo":this.cache.filter(a=>a.complexity_level==="5yo").length,normal:this.cache.filter(a=>a.complexity_level==="normal").length,advanced:this.cache.filter(a=>a.complexity_level==="advanced").length}},r=this.cache.length>0?this.cache.reduce((a,n)=>a+(e-n.cached_at),0)/this.cache.length:0;return{...t,avgAgeHours:Math.round(r/(1e3*60*60))}}}class qe{constructor(){p(this,"isOffline",!1);p(this,"listeners",new Set);this.initialize()}initialize(){this.isOffline=!navigator.onLine,window.addEventListener("online",()=>this.setOffline(!1)),window.addEventListener("offline",()=>this.setOffline(!0)),setInterval(()=>this.checkConnectivity(),3e4)}async checkConnectivity(){try{const e=await fetch("https://stupify.ai/api/health",{method:"HEAD",cache:"no-cache"});this.setOffline(!e.ok)}catch{this.setOffline(!0)}}setOffline(e){this.isOffline!==e&&(this.isOffline=e,this.listeners.forEach(t=>{try{t(e)}catch(r){console.error("❌ Offline listener error:",r)}}),e&&this.showOfflineNotification())}showOfflineNotification(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"info",message:"You're offline. Showing cached results."}}).catch(()=>{})}isCurrentlyOffline(){return this.isOffline}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}}const W=new De,He=new qe;class Be{constructor(){p(this,"cache",new Map)}async generate(e){const{question:t,answer:r,complexityLevel:a,conversationContext:n=[]}=e,o=this.getCacheKey(t,a);if(this.cache.has(o))return this.cache.get(o);try{const d=(await b.request("/api/followups/generate",{method:"POST",body:JSON.stringify({question:t,answer:r,complexityLevel:a,conversationContext:n}),requiresAuth:!1})).followUps||[],c=this.validateFollowUps(d,t);if(this.cache.set(o,c),this.cache.size>50){const u=this.cache.keys().next().value;this.cache.delete(u)}return c}catch(l){return console.error("❌ Failed to generate follow-ups:",l),this.generateLocal(e)}}generateLocal(e){const{question:t,complexityLevel:r}=e,a=this.extractTopic(t);return this.getTemplates(r).map((o,l)=>{const d=["deeper","related","practical"];return{id:`local-${Date.now()}-${l}`,text:o.replace("{topic}",a),category:d[l]||"related"}})}getTemplates(e){const t={"5yo":["Why is {topic} important?","What else works like {topic}?","Can you show me {topic} with a picture?"],normal:["How does {topic} actually work?","What are some real-world examples of {topic}?","What are the limitations of {topic}?"],advanced:["What are the technical details of {topic}?","How does {topic} compare to alternatives?","What are the edge cases of {topic}?"]};return t[e]||t.normal}extractTopic(e){const r=e.toLowerCase().replace(/^(what|how|why|when|where|who|can you|could you|please|explain|tell me about)\s+/gi,"").replace(/[?.!,]/g,"").trim().split(" ");return r.slice(0,Math.min(4,r.length)).join(" ")}validateFollowUps(e,t){const r=[],a=new Set;for(const n of e){if(!this.isValidFollowUp(n,t))continue;const o=n.text.toLowerCase().trim();if(!a.has(o)&&(a.add(o),r.push(n),r.length>=3))break}return r}isValidFollowUp(e,t){const r=e.text.trim();return!(r.length<10||r.length>150||this.calculateSimilarity(r,t)>.8||!this.isQuestion(r)||!["deeper","related","practical"].includes(e.category))}isQuestion(e){return e.endsWith("?")||/^(what|how|why|when|where|who|can|could|would|should|is|are|do|does)/i.test(e)}calculateSimilarity(e,t){const r=new Set(e.toLowerCase().split(/\s+/)),a=new Set(t.toLowerCase().split(/\s+/)),n=new Set([...r].filter(l=>a.has(l))),o=new Set([...r,...a]);return n.size/o.size}getCacheKey(e,t){return`${e.toLowerCase().trim()}-${t}`}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}assignCategories(e){return e.map((t,r)=>{const a=this.inferCategory(t,r);return{id:`generated-${Date.now()}-${r}`,text:t,category:a}})}inferCategory(e,t){const r=e.toLowerCase();return r.includes("why")||r.includes("how does")||r.includes("explain more")||r.includes("detail")?"deeper":r.includes("example")||r.includes("use")||r.includes("apply")||r.includes("real world")||r.includes("practice")?"practical":r.includes("similar")||r.includes("related")||r.includes("other")||r.includes("compare")?"related":["deeper","related","practical"][t%3]}}const We=new Be;var Qe={};const $=10,Ve=1e3;class Ke{constructor(){p(this,"currentState",{remaining:$,limit:$,used:0,resetAt:this.getNextResetTime(),isPremium:!1,isLoading:!0});p(this,"listeners",new Set);p(this,"syncInterval",null);this.initialize()}async initialize(){await this.loadCachedUsage();const e=A.isPremium();this.updateState({...this.currentState,isPremium:e}),await this.sync(),this.syncInterval=window.setInterval(()=>this.sync(),5*60*1e3),A.subscribe(t=>{var a;const r=((a=t.user)==null?void 0:a.subscription_tier)==="premium";this.updateState({...this.currentState,isPremium:r}),this.sync()})}async loadCachedUsage(){try{const t=(await chrome.storage.local.get(["dailyUsage"])).dailyUsage;t&&this.isToday(t.date)&&this.updateState({...this.currentState,used:t.used||0,remaining:Math.max(0,this.currentState.limit-(t.used||0)),isLoading:!1})}catch(e){console.error("❌ Failed to load cached usage:",e)}}async saveUsage(){try{await chrome.storage.local.set({dailyUsage:{date:this.getCurrentDate(),used:this.currentState.used,limit:this.currentState.limit}})}catch(e){console.error("❌ Failed to save usage:",e)}}async sync(){try{if(!await b.isAuthenticated()){this.updateState({...this.currentState,isLoading:!1});return}const t=await b.checkUsage(),r=A.isPremium(),a=r?Ve:$,n=a-t.remaining;this.updateState({remaining:t.remaining,limit:a,used:n,resetAt:t.resetAt,isPremium:r,isLoading:!1}),await this.saveUsage()}catch(e){console.error("❌ Usage sync failed:",e),this.updateState({...this.currentState,isLoading:!1})}}canAsk(){return this.currentState.isPremium?!0:this.currentState.remaining>0}async recordQuestion(){if(this.currentState.isPremium)return;const e=this.currentState.used+1,t=Math.max(0,this.currentState.limit-e);this.updateState({...this.currentState,used:e,remaining:t}),await this.saveUsage(),t===3?this.showLowUsageWarning():t===0&&this.showLimitReached(),setTimeout(()=>this.sync(),1e3)}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}updateState(e){this.currentState=e,this.listeners.forEach(t=>{try{t(e)}catch(r){console.error("❌ Usage listener error:",r)}}),this.updateBadge()}updateBadge(){if(this.currentState.isPremium){chrome.action.setBadgeText({text:"∞"}),chrome.action.setBadgeBackgroundColor({color:"#10b981"});return}const e=this.currentState.remaining;e===0?(chrome.action.setBadgeText({text:"0"}),chrome.action.setBadgeBackgroundColor({color:"#ef4444"})):e<=3?(chrome.action.setBadgeText({text:e.toString()}),chrome.action.setBadgeBackgroundColor({color:"#f59e0b"})):(chrome.action.setBadgeText({text:e.toString()}),chrome.action.setBadgeBackgroundColor({color:"#8b5cf6"}))}showLowUsageWarning(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"warning",message:`Only ${this.currentState.remaining} questions left today!`,action:{text:"Upgrade",onClick:()=>this.openPricingPage()}}}).catch(()=>{})}showLimitReached(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"error",message:"Daily limit reached! Upgrade for unlimited questions.",action:{text:"Upgrade Now",onClick:()=>this.openPricingPage()}}}).catch(()=>{})}openPricingPage(){chrome.tabs.create({url:`${Qe.VITE_API_URL||"https://stupify.ai"}/pricing?ref=extension`})}getTimeUntilReset(){const e=new Date,r=new Date(this.currentState.resetAt).getTime()-e.getTime();if(r<0)return"Soon";const a=Math.floor(r/(1e3*60*60)),n=Math.floor(r%(1e3*60*60)/(1e3*60));return a>0?`${a}h ${n}m`:`${n}m`}getPercentageUsed(){return this.currentState.limit===0?0:Math.round(this.currentState.used/this.currentState.limit*100)}isToday(e){return e===this.getCurrentDate()}getCurrentDate(){return new Date().toISOString().split("T")[0]}getNextResetTime(){const e=new Date;return e.setUTCHours(24,0,0,0),e.toISOString()}destroy(){this.syncInterval&&(window.clearInterval(this.syncInterval),this.syncInterval=null),this.listeners.clear()}}const _=new Ke;var Ye={};async function Je(i,e,t=[],r){const{onToken:a,onComplete:n,onError:o,signal:l}=r;let d="",c=null;try{const u=await b.getAccessToken();if(!u)throw new Error("Not authenticated");c=new AbortController,l&&l.addEventListener("abort",()=>{c==null||c.abort()});const C=[...t,{role:"user",content:i}],f=await fetch(`${Ye.VITE_API_URL||"https://stupify.ai"}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},body:JSON.stringify({messages:C,simplicityLevel:e}),signal:c.signal});if(!f.ok){const S=await f.json();throw new Error(S.error||S.message||"Chat request failed")}if(!f.body)throw new Error("No response body");const E=f.body.getReader(),k=new TextDecoder;for(;;){const{done:S,value:M}=await E.read();if(S)break;const O=k.decode(M,{stream:!0}).split(`
`).filter(v=>v.trim());for(const v of O)try{if(!v.trim())continue;let y=v;v.includes(":")&&(y=v.split(":").slice(1).join(":"));try{const T=JSON.parse(y);T.content?y=T.content:typeof T=="string"&&(y=T)}catch{}y&&y.trim()&&(a(y),d+=y)}catch(y){console.error("Error parsing chunk:",y)}}n(d)}catch(u){if(u instanceof Error&&u.name==="AbortError"){console.log("🛑 Stream cancelled");return}console.error("❌ Stream error:",u),o(u)}}function Ge(){const i=new AbortController;return{signal:i.signal,cancel:()=>i.abort()}}async function Xe(i,e,t=[],r,a=2){let n=null;for(let o=0;o<a;o++)try{await Je(i,e,t,r);return}catch(l){if(n=l,n.message.includes("authenticated")||n.name==="AbortError")throw n;if(o<a-1){const d=Math.min(1e3*Math.pow(2,o),3e3);await new Promise(c=>setTimeout(c,d))}}throw n||new Error("Stream failed after retries")}const Ze=()=>{const{selectedText:i,complexity:e,explanation:t,followUpQuestions:r,isCollapsed:a,setComplexity:n,startExplanation:o,streamResponse:l,completeExplanation:d,setError:c,setFollowUpQuestions:u,markFollowUpClicked:C,toggleCollapse:f,setSelectedText:E}=Oe(),[k,S]=x.useState(!1),[M,F]=x.useState(10),[O,v]=x.useState(!1),[y,T]=x.useState(!1),U=x.useRef(null);x.useEffect(()=>{const h=A.subscribe(m=>{var j;S(m.isAuthenticated),v(((j=m.user)==null?void 0:j.subscription_tier)==="premium")});return A.checkAuthStatus(),h},[]),x.useEffect(()=>_.subscribe(m=>{F(m.remaining)}),[]),x.useEffect(()=>He.subscribe(m=>{T(m)}),[]),x.useEffect(()=>{const h=m=>{m.type==="OPEN_SIDE_PANEL"&&console.log("Opening side panel with text:",m.payload)};return chrome.runtime.onMessage.addListener(h),()=>chrome.runtime.onMessage.removeListener(h)},[]);const Q=h=>{try{return new URL(h).hostname.replace("www.","")}catch{return"Unknown"}},R=async()=>{if(!i)return;if(!_.canAsk()){c("Daily limit reached! Upgrade for unlimited questions.");return}const h=i.text;o();const m=await W.get(h,e);if(m){console.log("✅ Using cached response");const N=m.answer.split(" ");for(const g of N)l(g+" "),await new Promise(X=>setTimeout(X,30));d(),D(h,m.answer);return}const j=Ge();U.current=j;try{let N="";await Xe(h,e,[],{signal:j.signal,onToken:g=>{N+=g,l(g)},onComplete:async g=>{d(),await W.add(h,g,e),await _.recordQuestion(),D(h,g)},onError:g=>{c(g.message||"Failed to get explanation"),console.error("❌ Stream error:",g)}})}catch(N){c(N.message||"Failed to get explanation"),console.error("❌ Ask error:",N)}},D=async(h,m)=>{try{const N=(await We.generate({question:h,answer:m,complexityLevel:e})).map(g=>({id:g.id,question:g.text,category:g.category,clicked:!1}));u(N)}catch(j){console.error("❌ Failed to generate follow-ups:",j)}},V=()=>{R()},K=h=>{C(h.id),E({text:h.question,url:(i==null?void 0:i.url)||"",domain:(i==null?void 0:i.domain)||"Follow-up",timestamp:Date.now()}),setTimeout(()=>R(),100)},Y=()=>{U.current&&(U.current.cancel(),U.current=null)},J=async()=>{try{await A.loginWithWebApp()}catch(h){console.error("❌ Login failed:",h),c("Login failed. Please try again.")}},G=()=>{window.open("https://stupify.ai/chat","_blank")};return s.jsxs("div",{className:"h-screen flex flex-col bg-gradient-to-br from-primary-50 via-purple-50 to-pink-50",children:[s.jsx("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 shadow-sm",children:s.jsxs("div",{className:"px-6 py-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-primary-600 to-purple-600 rounded-lg flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-sm",children:"S"})}),s.jsx("h1",{className:"text-lg font-bold text-gray-900",children:"Stupify"})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[y&&s.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium",children:"Offline"}),k?s.jsx("div",{className:"flex items-center gap-2 text-sm",children:s.jsx("span",{className:"text-gray-600",children:O?s.jsx("span",{className:"px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded font-medium text-xs",children:"∞ Premium"}):s.jsxs("span",{className:"text-gray-700 font-medium",children:[M," left"]})})}):s.jsxs("button",{onClick:J,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[s.jsx(ve,{className:"w-4 h-4"}),"Login"]})]})]}),s.jsx(Ee,{selected:e,onChange:n,disabled:t.isLoading||t.isStreaming})]})}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsxs("div",{className:"p-6 space-y-6",children:[!i&&s.jsx(Me,{}),i&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:s.jsxs("button",{onClick:f,className:"w-full px-4 py-3 flex items-start justify-between gap-3 hover:bg-gray-50 transition-colors",children:[s.jsxs("div",{className:"flex-1 text-left",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx(we,{className:"w-4 h-4 text-gray-400"}),s.jsx("span",{className:"text-xs font-medium text-gray-500",children:Q(i.url)})]}),s.jsx("p",{className:`text-sm text-gray-700 ${a?"line-clamp-2":""}`,children:i.text})]}),a?s.jsx(le,{className:"w-5 h-5 text-gray-400 flex-shrink-0"}):s.jsx(de,{className:"w-5 h-5 text-gray-400 flex-shrink-0"})]})}),s.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6",children:[t.error?s.jsx(Pe,{error:t.error,onRetry:V}):t.response||t.isLoading?s.jsx(Ue,{text:t.response,isStreaming:t.isStreaming,isLoading:t.isLoading}):s.jsxs("div",{className:"text-center py-8",children:[s.jsx("button",{onClick:R,disabled:!_.canAsk(),className:"px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:_.canAsk()?"Explain This":"Daily Limit Reached"}),!_.canAsk()&&s.jsx("button",{onClick:()=>window.open("https://stupify.ai/pricing","_blank"),className:"mt-3 text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Upgrade for unlimited questions →"})]}),t.isStreaming&&s.jsx("div",{className:"mt-4 text-center",children:s.jsx("button",{onClick:Y,className:"text-sm text-gray-600 hover:text-gray-800 font-medium",children:"Cancel"})})]}),t.completed&&t.response&&s.jsx(Ie,{response:t.response,onOpenInApp:G}),r.length>0&&s.jsx(Le,{questions:r,onQuestionClick:K})]})]})}),s.jsx("div",{className:"flex-shrink-0 bg-white border-t border-gray-200 px-6 py-3",children:s.jsxs("p",{className:"text-xs text-center text-gray-500",children:["Made with 💜 by"," ",s.jsx("a",{href:"https://stupify.ai",target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-700 font-medium",children:"Stupify"})]})})]})};ae.createRoot(document.getElementById("root")).render(s.jsx(ie.StrictMode,{children:s.jsx(Ze,{})}));console.log("✅ Stupify Side Panel loaded");
