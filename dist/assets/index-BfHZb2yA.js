var le=Object.defineProperty;var ce=(t,s,r)=>s in t?le(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r;var D=(t,s,r)=>ce(t,typeof s!="symbol"?s+"":s,r);import{c as k,j as e,r as x,g as de,a as B,R as ue}from"./globals-DvHHdZrZ.js";import{b as K,L as me,E as pe,F as he,a as R,r as L,c as P}from"./rateLimiter-CeXPzy5c.js";import{S as G}from"./sparkles-CQiXILgo.js";import{C as xe}from"./check-DTC6RNqm.js";import{l as fe}from"./utils-edMwt5UB.js";import{C as ge}from"./chevron-right-zVMNHD0m.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["path",{d:"M12 18V5",key:"adv99a"}],["path",{d:"M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4",key:"1e3is1"}],["path",{d:"M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5",key:"1gqd8o"}],["path",{d:"M17.997 5.125a4 4 0 0 1 2.526 5.77",key:"iwvgf7"}],["path",{d:"M18 18a4 4 0 0 0 2-7.464",key:"efp6ie"}],["path",{d:"M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517",key:"1gq6am"}],["path",{d:"M6 18a4 4 0 0 1-2-7.464",key:"k1g0md"}],["path",{d:"M6.003 5.125a4 4 0 0 0-2.526 5.77",key:"q97ue3"}]],O=k("brain",ye);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],be=k("chevron-down",we);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],ve=k("chevron-up",je);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],ke=k("circle-alert",Ne);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3",key:"11bfej"}]],Ce=k("command",Se);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],_e=k("copy",Ee);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]],Te=k("crown",Le);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],$e=k("globe",Ue);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]],Ae=k("log-in",Me);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M14 4.1 12 6",key:"ita8i4"}],["path",{d:"m5.1 8-2.9-.8",key:"1go3kf"}],["path",{d:"m6 12-1.9 2",key:"mnht97"}],["path",{d:"M7.2 2.2 8 5.1",key:"1cfko1"}],["path",{d:"M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z",key:"s0h3yz"}]],Fe=k("mouse-pointer-click",Re);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],De=k("refresh-cw",Ie);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Oe=k("share-2",Pe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],Qe=k("trending-up",ze);class Ve{constructor(){D(this,"cache",new Map)}async generate(s){const{question:r,answer:a,complexityLevel:n,conversationContext:o=[]}=s,i=this.getCacheKey(r,n);if(this.cache.has(i))return this.cache.get(i);try{const p=(await K.request("/api/followups/generate",{method:"POST",body:JSON.stringify({question:r,answer:a,complexityLevel:n,conversationContext:o}),requiresAuth:!1})).followUps||[],l=this.validateFollowUps(p,r);if(this.cache.set(i,l),this.cache.size>50){const c=this.cache.keys().next().value;this.cache.delete(c)}return l}catch(u){return console.error("❌ Failed to generate follow-ups:",u),this.generateLocal(s)}}generateLocal(s){const{question:r,complexityLevel:a}=s,n=this.extractTopic(r);return this.getTemplates(a).map((i,u)=>{const p=["deeper","related","practical"];return{id:`local-${Date.now()}-${u}`,text:i.replace("{topic}",n),category:p[u]||"related"}})}getTemplates(s){const r={"5yo":["Why is {topic} important?","What else works like {topic}?","Can you show me {topic} with a picture?"],normal:["How does {topic} actually work?","What are some real-world examples of {topic}?","What are the limitations of {topic}?"],advanced:["What are the technical details of {topic}?","How does {topic} compare to alternatives?","What are the edge cases of {topic}?"]};return r[s]||r.normal}extractTopic(s){const a=s.toLowerCase().replace(/^(what|how|why|when|where|who|can you|could you|please|explain|tell me about)\s+/gi,"").replace(/[?.!,]/g,"").trim().split(" ");return a.slice(0,Math.min(4,a.length)).join(" ")}validateFollowUps(s,r){const a=[],n=new Set;for(const o of s){if(!this.isValidFollowUp(o,r))continue;const i=o.text.toLowerCase().trim();if(!n.has(i)&&(n.add(i),a.push(o),a.length>=3))break}return a}isValidFollowUp(s,r){const a=s.text.trim();return!(a.length<10||a.length>150||this.calculateSimilarity(a,r)>.8||!this.isQuestion(a)||!["deeper","related","practical"].includes(s.category))}isQuestion(s){return s.endsWith("?")||/^(what|how|why|when|where|who|can|could|would|should|is|are|do|does)/i.test(s)}calculateSimilarity(s,r){const a=new Set(s.toLowerCase().split(/\s+/)),n=new Set(r.toLowerCase().split(/\s+/)),o=new Set([...a].filter(u=>n.has(u))),i=new Set([...a,...n]);return o.size/i.size}getCacheKey(s,r){return`${s.toLowerCase().trim()}-${r}`}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}assignCategories(s){return s.map((r,a)=>{const n=this.inferCategory(r,a);return{id:`generated-${Date.now()}-${a}`,text:r,category:n}})}inferCategory(s,r){const a=s.toLowerCase();return a.includes("why")||a.includes("how does")||a.includes("explain more")||a.includes("detail")?"deeper":a.includes("example")||a.includes("use")||a.includes("apply")||a.includes("real world")||a.includes("practice")?"practical":a.includes("similar")||a.includes("related")||a.includes("other")||a.includes("compare")?"related":["deeper","related","practical"][r%3]}}const qe=new Ve;var We={};async function He(t,s,r=[],a){const{onToken:n,onComplete:o,onError:i,signal:u}=a;let p="",l=null;try{const c=await K.getAccessToken();if(!c)throw new Error("Not authenticated");l=new AbortController,u&&u.addEventListener("abort",()=>{l==null||l.abort()});const j=[...r,{role:"user",content:t}],f=await fetch(`${We.VITE_API_URL||"https://stupify.app"}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({messages:j,simplicityLevel:s,source:"extension"}),signal:l.signal});if(!f.ok){const S=await f.json();throw new Error(S.error||S.message||"Chat request failed")}if(!f.body)throw new Error("No response body");const h=f.body.getReader(),b=new TextDecoder;for(;;){const{done:S,value:T}=await h.read();if(S)break;const $=b.decode(T,{stream:!0}).split(`
`).filter(E=>E.trim());for(const E of $)try{if(!E.trim())continue;let v=E;E.includes(":")&&(v=E.split(":").slice(1).join(":"));try{const _=JSON.parse(v);_.content?v=_.content:typeof _=="string"&&(v=_)}catch{}v&&v.trim()&&(n(v),p+=v)}catch(v){console.error("Error parsing chunk:",v)}}o(p)}catch(c){if(c instanceof Error&&c.name==="AbortError"){console.log("🛑 Stream cancelled");return}console.error("❌ Stream error:",c),i(c)}}function z(){const t=new AbortController;return{signal:t.signal,cancel:()=>t.abort()}}async function Q(t,s,r=[],a,n=2){let o=null;for(let i=0;i<n;i++)try{await He(t,s,r,a);return}catch(u){if(o=u,o.message.includes("authenticated")||o.name==="AbortError")throw o;if(i<n-1){const p=Math.min(1e3*Math.pow(2,i),3e3);await new Promise(l=>setTimeout(l,p))}}throw o||new Error("Stream failed after retries")}const V={"5yo":{label:"5yo",description:"Like I'm 5",emoji:"🧸",color:"bg-pink-500 hover:bg-pink-600",selectedColor:"bg-pink-600 ring-pink-500"},normal:{label:"Normal",description:"Balanced",emoji:"⚖️",color:"bg-primary-500 hover:bg-primary-600",selectedColor:"bg-primary-600 ring-primary-500"},advanced:{label:"Advanced",description:"Technical",emoji:"🧠",color:"bg-purple-600 hover:bg-purple-700",selectedColor:"bg-purple-700 ring-purple-500"}},Be=({selected:t,onChange:s,disabled:r=!1})=>e.jsx("div",{className:"flex gap-2",children:Object.keys(V).map(a=>{const n=V[a],o=t===a;return e.jsx("button",{onClick:()=>s(a),disabled:r,className:`
              flex-1 px-3 py-2.5 rounded-lg font-medium text-sm
              transition-all duration-200
              disabled:opacity-50 disabled:cursor-not-allowed
              ${o?`${n.selectedColor} text-white ring-2 ring-offset-2 shadow-md`:"bg-white text-gray-700 hover:bg-gray-50 border border-gray-200"}
            `,children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-lg",children:n.emoji}),e.jsx("span",{className:"font-semibold",children:n.label}),e.jsx("span",{className:"text-xs opacity-75",children:n.description})]})},a)})}),Ke=({text:t,isStreaming:s,isLoading:r})=>{const a=x.useRef(null);return x.useEffect(()=>{s&&a.current&&a.current.scrollIntoView({behavior:"smooth"})},[t,s]),r&&!t?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(me,{className:"w-8 h-8 text-primary-600 animate-spin mx-auto"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Thinking..."})]})}):t?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsxs("div",{className:"text-gray-800 leading-relaxed whitespace-pre-wrap",children:[t,s&&e.jsx("span",{className:"inline-block w-0.5 h-4 ml-1 bg-primary-600 animate-pulse"})]})}),e.jsx("div",{ref:a})]}):null},Ge=({questions:t,onQuestionClick:s})=>t.length===0?null:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4 text-primary-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Keep Learning"})]}),e.jsx("div",{className:"space-y-2",children:t.map(r=>e.jsx("button",{onClick:()=>s(r),disabled:r.clicked,className:`
              w-full text-left px-4 py-3 rounded-lg
              transition-all duration-200
              ${r.clicked?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-primary-50 border border-gray-200 hover:border-primary-300 text-gray-700 hover:text-primary-700"}
            `,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary-500 mt-0.5",children:"→"}),e.jsx("span",{className:"text-sm",children:r.question})]})},r.id))})]}),Je=({response:t,onOpenInApp:s})=>{const[r,a]=x.useState(!1),n=async()=>{try{await navigator.clipboard.writeText(t),a(!0),setTimeout(()=>a(!1),2e3)}catch(i){console.error("Failed to copy:",i)}},o=async()=>{if(navigator.share)try{await navigator.share({title:"Stupify Explanation",text:t})}catch{console.log("Share cancelled or failed")}else n()};return e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:n,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:r?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-green-600",children:"Copied!"})]}):e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:"Copy"})]})}),e.jsxs("button",{onClick:o,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Share"})]}),s&&e.jsxs("button",{onClick:s,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:"Open App"})]})]})},Ye=({error:t,onRetry:s})=>e.jsx("div",{className:"rounded-lg bg-red-50 border border-red-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ke,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-red-900",children:"Something went wrong"}),e.jsx("p",{className:"text-sm text-red-700",children:t}),s&&e.jsxs("button",{onClick:s,className:"flex items-center gap-2 px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-md text-sm font-medium transition-colors",children:[e.jsx(De,{className:"w-4 h-4"}),"Try Again"]})]})]})}),Xe=()=>e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(Fe,{className:"w-8 h-8 text-primary-600"})}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Select Text to Get Started"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6 max-w-sm",children:"Highlight any text on this page and we'll explain it simply."}),e.jsxs("div",{className:"space-y-3 w-full max-w-xs",children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-primary-600 font-bold",children:"1"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Select Text"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Highlight any text on the page"})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-primary-600 font-bold",children:"2"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Right-Click"}),e.jsx("p",{className:"text-xs text-gray-500",children:'Choose "Simplify with Stupify"'})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Ce,{className:"w-4 h-4 text-primary-600"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Or Use Shortcut"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Cmd+Shift+S"})," ","(Mac) or"," ",e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-xs",children:"Ctrl+Shift+S"})," ","(Windows)"]})]})]})})]})]}),Ze={},q=t=>{let s;const r=new Set,a=(c,j)=>{const f=typeof c=="function"?c(s):c;if(!Object.is(f,s)){const h=s;s=j??(typeof f!="object"||f===null)?f:Object.assign({},s,f),r.forEach(b=>b(s,h))}},n=()=>s,p={setState:a,getState:n,getInitialState:()=>l,subscribe:c=>(r.add(c),()=>r.delete(c)),destroy:()=>{(Ze?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),r.clear()}},l=s=t(a,n,p);return p},et=t=>t?q(t):q;var J={exports:{}},Y={},X={exports:{}},Z={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var U=x;function tt(t,s){return t===s&&(t!==0||1/t===1/s)||t!==t&&s!==s}var st=typeof Object.is=="function"?Object.is:tt,rt=U.useState,at=U.useEffect,nt=U.useLayoutEffect,ot=U.useDebugValue;function it(t,s){var r=s(),a=rt({inst:{value:r,getSnapshot:s}}),n=a[0].inst,o=a[1];return nt(function(){n.value=r,n.getSnapshot=s,F(n)&&o({inst:n})},[t,r,s]),at(function(){return F(n)&&o({inst:n}),t(function(){F(n)&&o({inst:n})})},[t]),ot(r),r}function F(t){var s=t.getSnapshot;t=t.value;try{var r=s();return!st(t,r)}catch{return!0}}function lt(t,s){return s()}var ct=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?lt:it;Z.useSyncExternalStore=U.useSyncExternalStore!==void 0?U.useSyncExternalStore:ct;X.exports=Z;var dt=X.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var M=x,ut=dt;function mt(t,s){return t===s&&(t!==0||1/t===1/s)||t!==t&&s!==s}var pt=typeof Object.is=="function"?Object.is:mt,ht=ut.useSyncExternalStore,xt=M.useRef,ft=M.useEffect,gt=M.useMemo,yt=M.useDebugValue;Y.useSyncExternalStoreWithSelector=function(t,s,r,a,n){var o=xt(null);if(o.current===null){var i={hasValue:!1,value:null};o.current=i}else i=o.current;o=gt(function(){function p(h){if(!l){if(l=!0,c=h,h=a(h),n!==void 0&&i.hasValue){var b=i.value;if(n(b,h))return j=b}return j=h}if(b=j,pt(c,h))return b;var S=a(h);return n!==void 0&&n(b,S)?(c=h,b):(c=h,j=S)}var l=!1,c,j,f=r===void 0?null:r;return[function(){return p(s())},f===null?void 0:function(){return p(f())}]},[s,r,a,n]);var u=ht(t,o[0],o[1]);return ft(function(){i.hasValue=!0,i.value=u},[u]),yt(u),u};J.exports=Y;var wt=J.exports;const bt=de(wt),ee={},{useDebugValue:jt}=B,{useSyncExternalStoreWithSelector:vt}=bt;let W=!1;const Nt=t=>t;function kt(t,s=Nt,r){(ee?"production":void 0)!=="production"&&r&&!W&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),W=!0);const a=vt(t.subscribe,t.getState,t.getServerState||t.getInitialState,s,r);return jt(a),a}const H=t=>{(ee?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const s=typeof t=="function"?et(t):t,r=(a,n)=>kt(s,a,n);return Object.assign(r,s),r},St=t=>t?H(t):H,Ct=St((t,s)=>({selectedText:null,complexity:"normal",explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[],history:[],isCollapsed:!1,setSelectedText:r=>t({selectedText:r}),setComplexity:r=>t({complexity:r}),startExplanation:()=>t({explanation:{isLoading:!0,isStreaming:!0,response:"",error:null,completed:!1},followUpQuestions:[]}),streamResponse:r=>{const{explanation:a}=s();t({explanation:{...a,isLoading:!1,isStreaming:!0,response:a.response+r}})},completeExplanation:()=>{const{explanation:r,selectedText:a,complexity:n}=s();t({explanation:{...r,isStreaming:!1,completed:!0}}),a&&s().addToHistory({id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,question:a.text,complexity:n,response:r.response,followUps:[],timestamp:Date.now(),url:a.url})},setError:r=>t({explanation:{isLoading:!1,isStreaming:!1,response:"",error:r,completed:!1}}),clearExplanation:()=>t({explanation:{isLoading:!1,isStreaming:!1,response:"",error:null,completed:!1},followUpQuestions:[]}),setFollowUpQuestions:r=>t({followUpQuestions:r}),markFollowUpClicked:r=>{const{followUpQuestions:a}=s();t({followUpQuestions:a.map(n=>n.id===r?{...n,clicked:!0}:n)})},addToHistory:r=>{const{history:a}=s(),n=[r,...a].slice(0,20);t({history:n})},clearHistory:()=>t({history:[]}),toggleCollapse:()=>t(r=>({isCollapsed:!r.isCollapsed}))}));function Et(){const[t,s]=x.useState(null),[r,a]=x.useState(!0),[n,o]=x.useState(!1);x.useEffect(()=>{i();const c=setInterval(i,3e4);return()=>clearInterval(c)},[]);const i=async()=>{var c,j,f,h,b,S,T;try{const N=await chrome.storage.local.get(["daily_usage","stats","user_data","streak"]),$=new Date().toDateString(),v=((c=(N.daily_usage||{})[$])==null?void 0:c.count)||0,C=(N.user_data||{}).subscriptionTier==="premium";s({today:{questions:v,limit:C?9999:10},allTime:{totalQuestions:((j=N.stats)==null?void 0:j.totalExplanations)||0,topicsExplored:((f=N.stats)==null?void 0:f.topicsExplored)||0},streak:{current:((h=N.streak)==null?void 0:h.current)||0,longest:((b=N.streak)==null?void 0:b.longest)||0},favorite:{complexity:((S=N.stats)==null?void 0:S.favoriteComplexity)||"normal",count:((T=N.stats)==null?void 0:T.favoriteComplexityCount)||0},isPremium:C})}catch(N){fe.error("Failed to load stats:",N)}finally{a(!1)}},u=()=>{chrome.runtime.sendMessage({type:"TRACK_EVENT",payload:{event:"upgrade_cta_clicked",properties:{source:"stats_widget"}}}),chrome.tabs.create({url:"https://stupify.ai/pricing"})};if(r)return e.jsx("div",{className:"bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl p-4 border border-purple-200 animate-pulse",children:e.jsx("div",{className:"h-20 bg-white/50 rounded-lg"})});if(!t)return null;const p=t.today.questions/t.today.limit*100,l={"5yo":"🎈",normal:"💡",advanced:"🎓"}[t.favorite.complexity];return e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl border border-purple-200 overflow-hidden",children:[e.jsx("div",{className:"p-4 cursor-pointer hover:bg-white/30 transition-colors",onClick:()=>o(!n),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center",children:e.jsx(O,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Your Stats"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[t.today.questions," questions today"]})]})]}),e.jsx(ge,{className:`w-5 h-5 text-gray-400 transition-transform ${n?"rotate-90":""}`})]})}),n&&e.jsxs("div",{className:"px-4 pb-4 space-y-3",children:[e.jsxs("div",{className:"bg-white/80 backdrop-blur rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Today's Questions"}),e.jsxs("span",{className:"text-sm font-bold text-purple-600",children:[t.today.questions," / ",t.isPremium?"∞":t.today.limit]})]}),!t.isPremium&&e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all ${p>=80?"bg-red-500":p>=50?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(p,100)}%`}})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-white/80 backdrop-blur rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(he,{className:"w-4 h-4 text-orange-500"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Streak"})]}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:[t.streak.current,e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"days"})]})]}),e.jsxs("div",{className:"bg-white/80 backdrop-blur rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(O,{className:"w-4 h-4 text-purple-500"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Total"})]}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:t.allTime.totalQuestions})]}),e.jsxs("div",{className:"bg-white/80 backdrop-blur rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(Qe,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Topics"})]}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:t.allTime.topicsExplored})]}),e.jsxs("div",{className:"bg-white/80 backdrop-blur rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(G,{className:"w-4 h-4 text-yellow-500"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Favorite"})]}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:l})]})]}),!t.isPremium&&e.jsxs("button",{onClick:u,className:"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-lg p-3 font-semibold transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl",children:[e.jsx(Te,{className:"w-5 h-5"}),"Upgrade to Premium"]}),e.jsx("button",{onClick:()=>chrome.tabs.create({url:"https://stupify.ai/stats"}),className:"w-full text-sm text-purple-600 hover:text-purple-700 font-medium py-2",children:"View Full Dashboard →"})]})]})}var _t={};const Lt=()=>{const{selectedText:t,complexity:s,explanation:r,followUpQuestions:a,isCollapsed:n,setComplexity:o,startExplanation:i,streamResponse:u,completeExplanation:p,setError:l,setFollowUpQuestions:c,markFollowUpClicked:j,toggleCollapse:f,setSelectedText:h}=Ct(),[b,S]=x.useState(!1),[T,N]=x.useState(10),[$,E]=x.useState(!1),[v,_]=x.useState(!1),C=x.useRef(null);x.useEffect(()=>{const m=R.subscribe(d=>{var w;S(d.isAuthenticated),E(((w=d.user)==null?void 0:w.subscription_tier)==="premium")});return R.checkAuthStatus(),m},[]),x.useEffect(()=>L.subscribe(d=>{N(d.remaining)}),[]),x.useEffect(()=>{_(!1)},[]),x.useEffect(()=>{const m=d=>{d.type==="OPEN_SIDE_PANEL"&&console.log("Opening side panel with text:",d.payload)};return chrome.runtime.onMessage.addListener(m),()=>chrome.runtime.onMessage.removeListener(m)},[]);const te=m=>{try{return new URL(m).hostname.replace("www.","")}catch{return"Unknown"}},A=async()=>{if(!t)return;if(!L.canAsk()){l("Daily limit reached! Upgrade for unlimited questions.");return}const m=t.text;i();const d=await P.get(m,s);if(d){console.log("✅ Using cached response");const y=d.answer.split(" ");for(const g of y)u(g+" "),await new Promise(ie=>setTimeout(ie,30));p(),I(m,d.answer);return}const w=z();C.current=w;try{let y="";await Q(m,s,[],{signal:w.signal,onToken:g=>{y+=g,u(g)},onComplete:async g=>{p(),await P.add(m,g,s),await L.recordQuestion(),I(m,g)},onError:g=>{l(g.message||"Failed to get explanation"),console.error("❌ Stream error:",g)}})}catch(y){l(y.message||"Failed to get explanation"),console.error("❌ Ask error:",y)}};x.useEffect(()=>{(async()=>{try{const{pendingExplanation:d}=await chrome.storage.local.get("pendingExplanation");if(d!=null&&d.text){const w=d.text;console.log("📝 Found pending explanation:",w.substring(0,50)+"..."),h(w),await chrome.storage.local.remove("pendingExplanation"),setTimeout(async()=>{if(!L.canAsk()){l("Daily limit reached! Upgrade for unlimited questions.");return}i();try{const y=z();C.current=y,await Q(w,s,[],{onToken:g=>u(g),onComplete:()=>{p(),C.current=null},onError:g=>{l(g.message),C.current=null},signal:y.signal},2)}catch(y){console.error("❌ Stream error:",y),l(y.message||"Failed to get explanation")}},500)}}catch(d){console.error("❌ Error checking pending explanation:",d)}})()},[]);const I=async(m,d)=>{try{const y=(await qe.generate({question:m,answer:d,complexityLevel:s})).map(g=>({id:g.id,question:g.text,category:g.category,clicked:!1}));c(y)}catch(w){console.error("❌ Failed to generate follow-ups:",w)}},se=()=>{A()},re=m=>{j(m.id),h({text:m.question,url:(t==null?void 0:t.url)||"",domain:(t==null?void 0:t.domain)||"Follow-up",timestamp:Date.now()}),setTimeout(()=>A(),100)},ae=()=>{C.current&&(C.current.cancel(),C.current=null)},ne=async()=>{try{l("null");const m=`${_t.VITE_API_URL||"https://stupify.app"}/login?ref=extension&mode=popup`,d=window.open(m,"Stupify Login","width=450,height=650,menubar=no,toolbar=no,location=no,status=no"),w=setInterval(async()=>{try{d!=null&&d.closed&&(clearInterval(w),(await R.checkAuthStatus()).isAuthenticated?window.location.reload():l("Login cancelled or failed"))}catch(y){clearInterval(w),console.error("Auth check error:",y)}},1e3);setTimeout(()=>{clearInterval(w),d&&!d.closed&&(d.close(),l("Login timeout"))},5*60*1e3)}catch(m){console.error("❌ Login failed:",m),l("Login failed. Please try again.")}},oe=()=>{window.open("https://stupify.app/chat","_blank")};return e.jsxs("div",{className:"h-screen flex flex-col bg-gradient-to-br from-primary-50 via-purple-50 to-pink-50",children:[e.jsx("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 shadow-sm",children:e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-primary-600 to-purple-600 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-sm",children:"S"})}),e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:"Stupify"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[v&&e.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium",children:"Offline"}),b?e.jsx("div",{className:"flex items-center gap-2 text-sm",children:e.jsx("span",{className:"text-gray-600",children:$?e.jsx("span",{className:"px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded font-medium text-xs",children:"∞ Premium"}):e.jsxs("span",{className:"text-gray-700 font-medium",children:[T," left"]})})}):e.jsxs("button",{onClick:ne,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(Ae,{className:"w-4 h-4"}),"Login"]})]})]}),e.jsx(Be,{selected:s,onChange:o,disabled:r.isLoading||r.isStreaming})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx(Et,{}),!t&&e.jsx(Xe,{}),t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:e.jsxs("button",{onClick:f,className:"w-full px-4 py-3 flex items-start justify-between gap-3 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex-1 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx($e,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-xs font-medium text-gray-500",children:te(t.url)})]}),e.jsx("p",{className:`text-sm text-gray-700 ${n?"line-clamp-2":""}`,children:t.text})]}),n?e.jsx(be,{className:"w-5 h-5 text-gray-400 flex-shrink-0"}):e.jsx(ve,{className:"w-5 h-5 text-gray-400 flex-shrink-0"})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6",children:[r.error?e.jsx(Ye,{error:r.error,onRetry:se}):r.response||r.isLoading?e.jsx(Ke,{text:r.response,isStreaming:r.isStreaming,isLoading:r.isLoading}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("button",{onClick:A,"data-testid":"explain-button",disabled:!L.canAsk(),className:"px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:L.canAsk()?"Explain This":"Daily Limit Reached"}),!L.canAsk()&&e.jsx("button",{onClick:()=>window.open("https://stupify.app/pricing","_blank"),className:"mt-3 text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Upgrade for unlimited questions →"})]}),r.isStreaming&&e.jsx("div",{className:"mt-4 text-center",children:e.jsx("button",{onClick:ae,className:"text-sm text-gray-600 hover:text-gray-800 font-medium",children:"Cancel"})})]}),r.completed&&r.response&&e.jsx(Je,{response:r.response,onOpenInApp:oe}),a.length>0&&e.jsx(Ge,{questions:a,onQuestionClick:re})]})]})}),e.jsx("div",{className:"flex-shrink-0 bg-white border-t border-gray-200 px-6 py-3",children:e.jsxs("p",{className:"text-xs text-center text-gray-500",children:["Made with 💜 by"," ",e.jsx("a",{href:"https://stupify.app",target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-700 font-medium",children:"Stupify"})]})})]})};ue.createRoot(document.getElementById("root")).render(e.jsx(B.StrictMode,{children:e.jsx(Lt,{})}));console.log("✅ Stupify Side Panel loaded");
