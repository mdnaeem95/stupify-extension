var E=Object.defineProperty;var I=(o,e,t)=>e in o?E(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var n=(o,e,t)=>I(o,typeof e!="symbol"?e+"":e,t);import{c as A}from"./globals-DvHHdZrZ.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],F=A("external-link",C);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const b=[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]],j=A("flame",b);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const x=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],W=A("loader-circle",x);var L={};const M=L.VITE_API_URL||"https://stupify.app",m="https://uoylkabywklpmuhoxopr.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVveWxrYWJ5d2tscG11aG94b3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjUzNzMsImV4cCI6MjA3NTMwMTM3M30.GDHquoyblmr-tq4Vo-FISoSQejFENnMsFHQg3cTN4fM";class P{constructor(){n(this,"accessToken",null);n(this,"refreshToken",null);n(this,"isRefreshing",!1);n(this,"refreshPromise",null);this.loadTokens()}async loadTokens(){try{const{auth:e}=await chrome.storage.local.get("auth");this.accessToken=(e==null?void 0:e.accessToken)||null,this.refreshToken=(e==null?void 0:e.refreshToken)||null,console.log("üîë Tokens loaded:",{hasAccessToken:!!this.accessToken,hasRefreshToken:!!this.refreshToken})}catch(e){console.error("‚ùå Failed to load tokens:",e)}}async saveTokens(e,t){this.accessToken=e,this.refreshToken=t;const{auth:s}=await chrome.storage.local.get("auth");await chrome.storage.local.set({auth:{...s,accessToken:e,refreshToken:t}}),console.log("‚úÖ Tokens saved to storage")}async clearTokens(){this.accessToken=null,this.refreshToken=null,await chrome.storage.local.remove("auth"),console.log("‚úÖ Tokens cleared from storage")}async getAccessToken(){return this.accessToken||await this.loadTokens(),this.accessToken}async refreshAccessToken(){return this.isRefreshing&&this.refreshPromise?this.refreshPromise:(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch(`${m}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:p},body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok)throw new Error("Failed to refresh token");const t=await e.json();if(t.access_token&&t.refresh_token)await this.saveTokens(t.access_token,t.refresh_token);else throw new Error("Invalid token response")}catch(e){throw console.error("‚ùå Token refresh failed:",e),await this.clearTokens(),e}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),this.refreshPromise)}async request(e,t={}){const{requiresAuth:s=!0,retries:r=3,timeout:i=3e4,...a}=t;let l=null;for(let g=0;g<r;g++)try{const c=new Headers(a.headers);if(c.set("Content-Type","application/json"),s){const u=await this.getAccessToken();if(!u)throw new Error("Not authenticated");c.set("Authorization",`Bearer ${u}`)}const f=new AbortController,y=setTimeout(()=>f.abort(),i),d=await fetch(`${M}${e}`,{...a,headers:c,signal:f.signal});if(clearTimeout(y),d.status===401&&s&&g<r-1){console.log("üîÑ Token expired, refreshing..."),await this.refreshAccessToken();continue}if(!d.ok){const u={message:`Request failed: ${d.statusText}`,status:d.status};try{const k=await d.json();u.message=k.error||k.message||u.message,u.code=k.code}catch{}throw u}return await d.json()}catch(c){if(l=c,c.status===401||c.status===403)throw c;if(c instanceof Error&&c.name==="AbortError")throw new Error("Request timeout");if(g<r-1){const f=Math.min(1e3*Math.pow(2,g),5e3);await new Promise(y=>setTimeout(y,f))}}throw l||new Error("Request failed")}async login(e,t){var i;const s=await fetch(`${m}/auth/v1/token?grant_type=password`,{method:"POST",headers:{"Content-Type":"application/json",apikey:p},body:JSON.stringify({email:e,password:t})});if(!s.ok){const a=await s.json();throw new Error(a.error_description||a.message||"Login failed")}const r=await s.json();if(!r.access_token||!r.refresh_token)throw new Error("Invalid login response");await chrome.storage.local.set({auth:{accessToken:r.access_token,refreshToken:r.refresh_token,user:r.user||null}}),this.accessToken=r.access_token,this.refreshToken=r.refresh_token,console.log("‚úÖ Login successful:",{hasToken:!!this.accessToken,user:(i=r.user)==null?void 0:i.email})}async signup(e,t){var i;const s=await fetch(`${m}/auth/v1/signup`,{method:"POST",headers:{"Content-Type":"application/json",apikey:p},body:JSON.stringify({email:e,password:t})});if(!s.ok){const a=await s.json();throw new Error(a.error_description||a.message||"Signup failed")}const r=await s.json();if(!r.access_token||!r.refresh_token)throw new Error("Invalid signup response");await chrome.storage.local.set({auth:{accessToken:r.access_token,refreshToken:r.refresh_token,user:r.user||null}}),this.accessToken=r.access_token,this.refreshToken=r.refresh_token,console.log("‚úÖ Signup successful:",{hasToken:!!this.accessToken,user:(i=r.user)==null?void 0:i.email})}async logout(){try{this.accessToken&&await fetch(`${m}/auth/v1/logout`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,apikey:p}})}catch(e){console.error("‚ùå Logout error:",e)}finally{await this.clearTokens()}}async getUser(){const{auth:e}=await chrome.storage.local.get("auth");return(e==null?void 0:e.user)||null}async isAuthenticated(){return!!await this.getAccessToken()}async checkUsage(){return this.request("/api/usage",{requiresAuth:!0})}async getProfile(){return this.request("/api/user/profile",{requiresAuth:!0})}}const h=new P;var _={};class U{constructor(){n(this,"listeners",new Set);n(this,"currentState",{isAuthenticated:!1,user:null,loading:!0});this.initialize()}async initialize(){await this.checkAuthStatus(),chrome.runtime.onMessage.addListener((e,t,s)=>{e.type==="AUTH_STATE_CHANGED"&&(console.log("üì® AUTH_STATE_CHANGED message received",t,s),this.checkAuthStatus())}),chrome.storage.onChanged.addListener((e,t)=>{t==="local"&&e.auth&&(console.log("üîÑ Auth storage changed in SidePanel!",{had:!!e.auth.oldValue,now:!!e.auth.newValue}),this.checkAuthStatus())}),console.log("‚úÖ Auth service initialized")}async checkAuthStatus(){try{const e=await h.isAuthenticated(),t=e?await h.getUser():null;return this.updateState({isAuthenticated:e,user:t,loading:!1}),console.log("‚úÖ Auth status checked:",{isAuthenticated:e,user:(t==null?void 0:t.email)||"none"}),this.currentState}catch(e){return console.error("‚ùå Auth check failed:",e),this.updateState({isAuthenticated:!1,user:null,loading:!1}),this.currentState}}async login(e,t){try{this.updateState({...this.currentState,loading:!0}),await h.login(e,t);const s=await h.getUser();this.updateState({isAuthenticated:!0,user:s,loading:!1}),this.broadcastAuthChange(),this.trackEvent("extension_login",{method:"email"}),console.log("‚úÖ Login successful:",s==null?void 0:s.email)}catch(s){throw this.updateState({isAuthenticated:!1,user:null,loading:!1}),s}}async signup(e,t){try{this.updateState({...this.currentState,loading:!0}),await h.signup(e,t);const s=await h.getUser();this.updateState({isAuthenticated:!0,user:s,loading:!1}),this.broadcastAuthChange(),this.trackEvent("extension_signup",{method:"email"}),console.log("‚úÖ Signup successful:",s==null?void 0:s.email)}catch(s){throw this.updateState({isAuthenticated:!1,user:null,loading:!1}),s}}async logout(){try{await h.logout(),this.updateState({isAuthenticated:!1,user:null,loading:!1}),await chrome.storage.local.remove(["cachedExplanations","lastSync"]),this.broadcastAuthChange(),this.trackEvent("extension_logout"),console.log("‚úÖ Logout successful")}catch(e){throw console.error("‚ùå Logout error:",e),e}}async loginWithWebApp(){const e=await chrome.tabs.create({url:`${_.VITE_API_URL||"https://stupify.app"}/login?redirect=extension`});return console.log("üåê Opened web app for login, tab:",e.id),new Promise((t,s)=>{const r=async i=>{i.type==="WEB_AUTH_COMPLETE"&&i.tabId===e.id&&(chrome.runtime.onMessage.removeListener(r),console.log("‚úÖ Web auth completed, checking status..."),await this.checkAuthStatus(),this.currentState.isAuthenticated?t():s(new Error("Authentication failed")))};chrome.runtime.onMessage.addListener(r),setTimeout(()=>{chrome.runtime.onMessage.removeListener(r),s(new Error("Authentication timeout"))},5*60*1e3)})}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),e(this.currentState),()=>{this.listeners.delete(e)}}updateState(e){this.currentState=e,this.listeners.forEach(t=>{try{t(e)}catch(s){console.error("‚ùå Auth listener error:",s)}})}broadcastAuthChange(){chrome.runtime.sendMessage({type:"AUTH_STATE_CHANGED",payload:this.currentState}).catch(()=>{})}trackEvent(e,t){chrome.runtime.sendMessage({type:"TRACK_EVENT",payload:{event:e,properties:{...t,timestamp:Date.now()}}}).catch(()=>{})}async syncWithWebApp(){try{const e=await chrome.tabs.query({url:`${_.VITE_API_URL||"https://stupify.app"}/*`});if(e.length===0){console.log("No web app tabs found");return}console.log(`Found ${e.length} web app tab(s), syncing...`);for(const t of e)if(t.id)try{const s=await chrome.tabs.sendMessage(t.id,{type:"GET_AUTH_STATE"});if(s&&s.isAuthenticated){console.log("‚úÖ Got auth state from web app, saving..."),await chrome.storage.local.set({auth:{accessToken:s.accessToken,refreshToken:s.refreshToken,user:s.user}}),await this.checkAuthStatus();break}}catch{}}catch(e){console.error("‚ùå Sync error:",e)}}isPremium(){var e;return((e=this.currentState.user)==null?void 0:e.subscription_tier)==="premium"}getUserEmail(){var e;return((e=this.currentState.user)==null?void 0:e.email)||null}getUserId(){var e;return((e=this.currentState.user)==null?void 0:e.id)||null}}const S=new U,w="cachedExplanations",v=10,O=7*24*60*60*1e3;class z{constructor(){n(this,"cache",[]);n(this,"initialized",!1);this.initialize()}async initialize(){try{await this.loadCache(),this.initialized=!0}catch(e){console.error("‚ùå Cache initialization failed:",e)}}async loadCache(){try{const e=await chrome.storage.local.get([w]);this.cache=e[w]||[],this.cleanExpiredItems()}catch(e){console.error("‚ùå Failed to load cache:",e),this.cache=[]}}async saveCache(){try{await chrome.storage.local.set({[w]:this.cache})}catch(e){console.error("‚ùå Failed to save cache:",e)}}async add(e,t,s){this.initialized||await this.initialize();const r={question:e.trim().toLowerCase(),answer:t,complexity_level:s,cached_at:Date.now()};this.cache=this.cache.filter(i=>!(i.question===r.question&&i.complexity_level===r.complexity_level)),this.cache.unshift(r),this.cache.length>v&&(this.cache=this.cache.slice(0,v)),await this.saveCache()}async get(e,t){this.initialized||await this.initialize();const s=e.trim().toLowerCase(),r=this.cache.find(a=>a.question===s&&a.complexity_level===t);return r&&!this.isExpired(r)?r:this.cache.find(a=>a.complexity_level===t&&!this.isExpired(a)&&this.isSimilar(s,a.question))||null}isExpired(e){return Date.now()-e.cached_at>O}isSimilar(e,t){const s=new Set(e.split(" ").filter(l=>l.length>3)),r=new Set(t.split(" ").filter(l=>l.length>3));return s.size===0||r.size===0?!1:new Set([...s].filter(l=>r.has(l))).size/Math.min(s.size,r.size)>.6}cleanExpiredItems(){const e=this.cache.length;this.cache=this.cache.filter(t=>!this.isExpired(t)),this.cache.length<e&&this.saveCache()}async clear(){this.cache=[],await chrome.storage.local.remove([w])}getSize(){return this.cache.length}getAll(){return[...this.cache]}getStats(){const e=Date.now(),t={total:this.cache.length,expired:this.cache.filter(r=>this.isExpired(r)).length,byLevel:{"5yo":this.cache.filter(r=>r.complexity_level==="5yo").length,normal:this.cache.filter(r=>r.complexity_level==="normal").length,advanced:this.cache.filter(r=>r.complexity_level==="advanced").length}},s=this.cache.length>0?this.cache.reduce((r,i)=>r+(e-i.cached_at),0)/this.cache.length:0;return{...t,avgAgeHours:Math.round(s/(1e3*60*60))}}}class N{constructor(){n(this,"isOffline",!1);n(this,"listeners",new Set);this.initialize()}initialize(){this.isOffline=!navigator.onLine,window.addEventListener("online",()=>this.setOffline(!1)),window.addEventListener("offline",()=>this.setOffline(!0)),setInterval(()=>this.checkConnectivity(),3e4)}async checkConnectivity(){try{const e=await fetch("https://stupify.app/api/health",{method:"HEAD",cache:"no-cache"});this.setOffline(!e.ok)}catch{this.setOffline(!0)}}setOffline(e){this.isOffline!==e&&(this.isOffline=e,this.listeners.forEach(t=>{try{t(e)}catch(s){console.error("‚ùå Offline listener error:",s)}}),e&&this.showOfflineNotification())}showOfflineNotification(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"info",message:"You're offline. Showing cached results."}}).catch(()=>{})}isCurrentlyOffline(){return this.isOffline}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}}const V=new z;new N;var R={};const T=10,q=1e3;class B{constructor(){n(this,"currentState",{remaining:T,limit:T,used:0,resetAt:this.getNextResetTime(),isPremium:!1,isLoading:!0});n(this,"listeners",new Set);n(this,"syncInterval",null);this.initialize()}async initialize(){await this.loadCachedUsage();const e=S.isPremium();this.updateState({...this.currentState,isPremium:e}),await this.sync(),this.syncInterval=window.setInterval(()=>this.sync(),5*60*1e3),S.subscribe(t=>{var r;const s=((r=t.user)==null?void 0:r.subscription_tier)==="premium";this.updateState({...this.currentState,isPremium:s}),this.sync()})}async loadCachedUsage(){try{const t=(await chrome.storage.local.get(["dailyUsage"])).dailyUsage;t&&this.isToday(t.date)&&this.updateState({...this.currentState,used:t.used||0,remaining:Math.max(0,this.currentState.limit-(t.used||0)),isLoading:!1})}catch(e){console.error("‚ùå Failed to load cached usage:",e)}}async saveUsage(){try{await chrome.storage.local.set({dailyUsage:{date:this.getCurrentDate(),used:this.currentState.used,limit:this.currentState.limit}})}catch(e){console.error("‚ùå Failed to save usage:",e)}}async sync(){try{if(!await h.isAuthenticated()){this.updateState({...this.currentState,isLoading:!1});return}const t=await h.checkUsage(),s=S.isPremium(),r=s?q:T,i=r-t.remaining;this.updateState({remaining:t.remaining,limit:r,used:i,resetAt:t.resetAt,isPremium:s,isLoading:!1}),await this.saveUsage()}catch(e){console.error("‚ùå Usage sync failed:",e),this.updateState({...this.currentState,isLoading:!1})}}canAsk(){return this.currentState.isPremium?!0:this.currentState.remaining>0}async recordQuestion(){if(this.currentState.isPremium)return;const e=this.currentState.used+1,t=Math.max(0,this.currentState.limit-e);this.updateState({...this.currentState,used:e,remaining:t}),await this.saveUsage(),t===3?this.showLowUsageWarning():t===0&&this.showLimitReached(),setTimeout(()=>this.sync(),1e3)}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}updateState(e){this.currentState=e,this.listeners.forEach(t=>{try{t(e)}catch(s){console.error("‚ùå Usage listener error:",s)}}),this.updateBadge()}updateBadge(){if(this.currentState.isPremium){chrome.action.setBadgeText({text:"‚àû"}),chrome.action.setBadgeBackgroundColor({color:"#10b981"});return}const e=this.currentState.remaining;e===0?(chrome.action.setBadgeText({text:"0"}),chrome.action.setBadgeBackgroundColor({color:"#ef4444"})):e<=3?(chrome.action.setBadgeText({text:e.toString()}),chrome.action.setBadgeBackgroundColor({color:"#f59e0b"})):(chrome.action.setBadgeText({text:e.toString()}),chrome.action.setBadgeBackgroundColor({color:"#8b5cf6"}))}showLowUsageWarning(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"warning",message:`Only ${this.currentState.remaining} questions left today!`,action:{text:"Upgrade",onClick:()=>this.openPricingPage()}}}).catch(()=>{})}showLimitReached(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"error",message:"Daily limit reached! Upgrade for unlimited questions.",action:{text:"Upgrade Now",onClick:()=>this.openPricingPage()}}}).catch(()=>{})}openPricingPage(){chrome.tabs.create({url:`${R.VITE_API_URL||"https://stupify.app"}/pricing?ref=extension`})}getTimeUntilReset(){const e=new Date,s=new Date(this.currentState.resetAt).getTime()-e.getTime();if(s<0)return"Soon";const r=Math.floor(s/(1e3*60*60)),i=Math.floor(s%(1e3*60*60)/(1e3*60));return r>0?`${r}h ${i}m`:`${i}m`}getPercentageUsed(){return this.currentState.limit===0?0:Math.round(this.currentState.used/this.currentState.limit*100)}isToday(e){return e===this.getCurrentDate()}getCurrentDate(){return new Date().toISOString().split("T")[0]}getNextResetTime(){const e=new Date;return e.setUTCHours(24,0,0,0),e.toISOString()}destroy(){this.syncInterval&&(window.clearInterval(this.syncInterval),this.syncInterval=null),this.listeners.clear()}}const J=new B;export{F as E,j as F,W as L,S as a,h as b,V as c,J as r};
