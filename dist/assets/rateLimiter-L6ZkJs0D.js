var e,t,s=Object.defineProperty,i=(e,t,i)=>((e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);const a={}.VITE_API_URL||"https://stupify.app",r="https://uoylkabywklpmuhoxopr.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVveWxrYWJ5d2tscG11aG94b3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjUzNzMsImV4cCI6MjA3NTMwMTM3M30.GDHquoyblmr-tq4Vo-FISoSQejFENnMsFHQg3cTN4fM";const o=new class{constructor(){i(this,"accessToken",null),i(this,"refreshToken",null),i(this,"isRefreshing",!1),i(this,"refreshPromise",null),this.loadTokens()}async loadTokens(){try{const{auth:e}=await chrome.storage.local.get("auth");this.accessToken=(null==e?void 0:e.accessToken)||null,this.refreshToken=(null==e?void 0:e.refreshToken)||null}catch(e){}}async saveTokens(e,t){this.accessToken=e,this.refreshToken=t;const{auth:s}=await chrome.storage.local.get("auth");await chrome.storage.local.set({auth:{...s,accessToken:e,refreshToken:t}})}async clearTokens(){this.accessToken=null,this.refreshToken=null,await chrome.storage.local.remove("auth")}async getAccessToken(){return this.accessToken||await this.loadTokens(),this.accessToken}async refreshAccessToken(){return this.isRefreshing&&this.refreshPromise||(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch(`${r}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:n},body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok)throw new Error("Failed to refresh token");const t=await e.json();if(!t.access_token||!t.refresh_token)throw new Error("Invalid token response");await this.saveTokens(t.access_token,t.refresh_token)}catch(e){throw await this.clearTokens(),e}finally{this.isRefreshing=!1,this.refreshPromise=null}})()),this.refreshPromise}async request(e,t={}){const{requiresAuth:s=!0,retries:i=3,timeout:r=3e4,...n}=t;let o=null;for(let h=0;h<i;h++)try{const t=new Headers(n.headers);if(t.set("Content-Type","application/json"),s){const e=await this.getAccessToken();if(!e)throw new Error("Not authenticated");t.set("Authorization",`Bearer ${e}`)}const o=new AbortController,c=setTimeout(()=>o.abort(),r),l=await fetch(`${a}${e}`,{...n,headers:t,signal:o.signal});if(clearTimeout(c),401===l.status&&s&&h<i-1){await this.refreshAccessToken();continue}if(!l.ok){const e={message:`Request failed: ${l.statusText}`,status:l.status};try{const t=await l.json();e.message=t.error||t.message||e.message,e.code=t.code}catch{}throw e}return await l.json()}catch(c){if(o=c,401===c.status||403===c.status)throw c;if(c instanceof Error&&"AbortError"===c.name)throw new Error("Request timeout");if(h<i-1){const e=Math.min(1e3*Math.pow(2,h),5e3);await new Promise(t=>setTimeout(t,e))}}throw o||new Error("Request failed")}async login(e,t){const s=await fetch(`${r}/auth/v1/token?grant_type=password`,{method:"POST",headers:{"Content-Type":"application/json",apikey:n},body:JSON.stringify({email:e,password:t})});if(!s.ok){const e=await s.json();throw new Error(e.error_description||e.message||"Login failed")}const i=await s.json();if(!i.access_token||!i.refresh_token)throw new Error("Invalid login response");await chrome.storage.local.set({auth:{accessToken:i.access_token,refreshToken:i.refresh_token,user:i.user||null}}),this.accessToken=i.access_token,this.refreshToken=i.refresh_token}async signup(e,t){const s=await fetch(`${r}/auth/v1/signup`,{method:"POST",headers:{"Content-Type":"application/json",apikey:n},body:JSON.stringify({email:e,password:t})});if(!s.ok){const e=await s.json();throw new Error(e.error_description||e.message||"Signup failed")}const i=await s.json();if(!i.access_token||!i.refresh_token)throw new Error("Invalid signup response");await chrome.storage.local.set({auth:{accessToken:i.access_token,refreshToken:i.refresh_token,user:i.user||null}}),this.accessToken=i.access_token,this.refreshToken=i.refresh_token}async logout(){try{this.accessToken&&await fetch(`${r}/auth/v1/logout`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,apikey:n}})}catch(e){}finally{await this.clearTokens()}}async getUser(){const{auth:e}=await chrome.storage.local.get("auth");return(null==e?void 0:e.user)||null}async isAuthenticated(){return!!(await this.getAccessToken())}async checkUsage(){return this.request("/api/usage",{requiresAuth:!0})}async getProfile(){return this.request("/api/user/profile",{requiresAuth:!0})}};var c={};const h=new class{constructor(){i(this,"listeners",new Set),i(this,"currentState",{isAuthenticated:!1,user:null,loading:!0}),i(this,"messageListener",null),i(this,"storageListener",null),this.initialize()}async initialize(){await this.checkAuthStatus(),this.messageListener=(e,t,s)=>{"AUTH_STATE_CHANGED"===e.type&&this.checkAuthStatus()},chrome.runtime.onMessage.addListener(this.messageListener),this.storageListener=(e,t)=>{"local"===t&&e.auth&&this.checkAuthStatus()},chrome.storage.onChanged.addListener(this.storageListener)}async checkAuthStatus(){try{const e=await o.isAuthenticated(),t=e?await o.getUser():null;return this.updateState({isAuthenticated:e,user:t,loading:!1}),this.currentState}catch(e){return this.updateState({isAuthenticated:!1,user:null,loading:!1}),this.currentState}}async login(e,t){try{this.updateState({...this.currentState,loading:!0}),await o.login(e,t);const s=await o.getUser();this.updateState({isAuthenticated:!0,user:s,loading:!1}),this.broadcastAuthChange(),this.trackEvent("extension_login",{method:"email"})}catch(s){throw this.updateState({isAuthenticated:!1,user:null,loading:!1}),s}}async signup(e,t){try{this.updateState({...this.currentState,loading:!0}),await o.signup(e,t);const s=await o.getUser();this.updateState({isAuthenticated:!0,user:s,loading:!1}),this.broadcastAuthChange(),this.trackEvent("extension_signup",{method:"email"})}catch(s){throw this.updateState({isAuthenticated:!1,user:null,loading:!1}),s}}async logout(){try{await o.logout(),this.updateState({isAuthenticated:!1,user:null,loading:!1}),await chrome.storage.local.remove(["cachedExplanations","lastSync"]),this.broadcastAuthChange(),this.trackEvent("extension_logout")}catch(e){throw e}}async loginWithWebApp(){const e=await chrome.tabs.create({url:`${c.VITE_API_URL||"https://stupify.app"}/login?redirect=extension`});return new Promise((t,s)=>{const i=async a=>{"WEB_AUTH_COMPLETE"===a.type&&a.tabId===e.id&&(chrome.runtime.onMessage.removeListener(i),await this.checkAuthStatus(),this.currentState.isAuthenticated?t():s(new Error("Authentication failed")))};chrome.runtime.onMessage.addListener(i),setTimeout(()=>{chrome.runtime.onMessage.removeListener(i),s(new Error("Authentication timeout"))},3e5)})}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),e(this.currentState),()=>{this.listeners.delete(e)}}updateState(e){this.currentState=e,this.listeners.forEach(t=>{try{t(e)}catch(s){}})}broadcastAuthChange(){chrome.runtime.sendMessage({type:"AUTH_STATE_CHANGED",payload:this.currentState}).catch(()=>{})}trackEvent(e,t){chrome.runtime.sendMessage({type:"TRACK_EVENT",payload:{event:e,properties:{...t,timestamp:Date.now()}}}).catch(()=>{})}async syncWithWebApp(){try{const e=await chrome.tabs.query({url:`${c.VITE_API_URL||"https://stupify.app"}/*`});if(0===e.length)return;for(const t of e)if(t.id)try{const e=await chrome.tabs.sendMessage(t.id,{type:"GET_AUTH_STATE"});if(e&&e.isAuthenticated){await chrome.storage.local.set({auth:{accessToken:e.accessToken,refreshToken:e.refreshToken,user:e.user}}),await this.checkAuthStatus();break}}catch{}}catch(e){}}isPremium(){var e;return"premium"===(null==(e=this.currentState.user)?void 0:e.subscription_tier)}getUserEmail(){var e;return(null==(e=this.currentState.user)?void 0:e.email)||null}getUserId(){var e;return(null==(e=this.currentState.user)?void 0:e.id)||null}destroy(){this.messageListener&&(chrome.runtime.onMessage.removeListener(this.messageListener),this.messageListener=null),this.storageListener&&(chrome.storage.onChanged.removeListener(this.storageListener),this.storageListener=null),this.listeners.clear()}};"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{h.destroy()}),"undefined"!=typeof chrome&&(null==(e=chrome.runtime)?void 0:e.onSuspend)&&chrome.runtime.onSuspend.addListener(()=>{h.destroy()});const l="cachedExplanations";const u=new class{constructor(){i(this,"cache",[]),i(this,"initialized",!1),this.initialize()}async initialize(){try{await this.loadCache(),this.initialized=!0}catch(e){}}async loadCache(){try{const e=await chrome.storage.local.get([l]);this.cache=e[l]||[],this.cleanExpiredItems()}catch(e){this.cache=[]}}async saveCache(){try{await chrome.storage.local.set({[l]:this.cache})}catch(e){}}async add(e,t,s){this.initialized||await this.initialize();const i={question:e.trim().toLowerCase(),answer:t,complexity_level:s,cached_at:Date.now()};this.cache=this.cache.filter(e=>!(e.question===i.question&&e.complexity_level===i.complexity_level)),this.cache.unshift(i),this.cache.length>10&&(this.cache=this.cache.slice(0,10)),await this.saveCache()}async get(e,t){this.initialized||await this.initialize();const s=e.trim().toLowerCase(),i=this.cache.find(e=>e.question===s&&e.complexity_level===t);if(i&&!this.isExpired(i))return i;return this.cache.find(e=>e.complexity_level===t&&!this.isExpired(e)&&this.isSimilar(s,e.question))||null}isExpired(e){return Date.now()-e.cached_at>6048e5}isSimilar(e,t){const s=new Set(e.split(" ").filter(e=>e.length>3)),i=new Set(t.split(" ").filter(e=>e.length>3));if(0===s.size||0===i.size)return!1;return new Set([...s].filter(e=>i.has(e))).size/Math.min(s.size,i.size)>.6}cleanExpiredItems(){const e=this.cache.length;this.cache=this.cache.filter(e=>!this.isExpired(e)),this.cache.length<e&&this.saveCache()}async clear(){this.cache=[],await chrome.storage.local.remove([l])}getSize(){return this.cache.length}getAll(){return[...this.cache]}getStats(){const e=Date.now(),t={total:this.cache.length,expired:this.cache.filter(e=>this.isExpired(e)).length,byLevel:{"5yo":this.cache.filter(e=>"5yo"===e.complexity_level).length,normal:this.cache.filter(e=>"normal"===e.complexity_level).length,advanced:this.cache.filter(e=>"advanced"===e.complexity_level).length}},s=this.cache.length>0?this.cache.reduce((t,s)=>t+(e-s.cached_at),0)/this.cache.length:0;return{...t,avgAgeHours:Math.round(s/36e5)}}};new class{constructor(){i(this,"isOffline",!1),i(this,"listeners",new Set),this.initialize()}initialize(){this.isOffline=!navigator.onLine,window.addEventListener("online",()=>this.setOffline(!1)),window.addEventListener("offline",()=>this.setOffline(!0)),setInterval(()=>this.checkConnectivity(),3e4)}async checkConnectivity(){try{const e=await fetch("https://stupify.app/api/health",{method:"HEAD",cache:"no-cache"});this.setOffline(!e.ok)}catch{this.setOffline(!0)}}setOffline(e){this.isOffline!==e&&(this.isOffline=e,this.listeners.forEach(t=>{try{t(e)}catch(s){}}),e&&this.showOfflineNotification())}showOfflineNotification(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"info",message:"You're offline. Showing cached results."}}).catch(()=>{})}isCurrentlyOffline(){return this.isOffline}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}};var d={};const g=new class{constructor(){i(this,"currentState",{remaining:10,limit:10,used:0,resetAt:this.getNextResetTime(),isPremium:!1,isLoading:!0}),i(this,"listeners",new Set),i(this,"syncInterval",null),this.initialize()}async initialize(){await this.loadCachedUsage();const e=h.isPremium();this.updateState({...this.currentState,isPremium:e}),await this.sync(),this.syncInterval=window.setInterval(()=>this.sync(),3e5),h.subscribe(e=>{var t;const s="premium"===(null==(t=e.user)?void 0:t.subscription_tier);this.updateState({...this.currentState,isPremium:s}),this.sync()})}async loadCachedUsage(){try{const e=(await chrome.storage.local.get(["dailyUsage"])).dailyUsage;e&&this.isToday(e.date)&&this.updateState({...this.currentState,used:e.used||0,remaining:Math.max(0,this.currentState.limit-(e.used||0)),isLoading:!1})}catch(e){}}async saveUsage(){try{await chrome.storage.local.set({dailyUsage:{date:this.getCurrentDate(),used:this.currentState.used,limit:this.currentState.limit}})}catch(e){}}async sync(){try{if(!(await o.isAuthenticated()))return void this.updateState({...this.currentState,isLoading:!1});const e=await o.checkUsage(),t=h.isPremium(),s=t?1e3:10,i=s-e.remaining;this.updateState({remaining:e.remaining,limit:s,used:i,resetAt:e.resetAt,isPremium:t,isLoading:!1}),await this.saveUsage()}catch(e){this.updateState({...this.currentState,isLoading:!1})}}canAsk(){return!!this.currentState.isPremium||this.currentState.remaining>0}async recordQuestion(){if(this.currentState.isPremium)return;const e=this.currentState.used+1,t=Math.max(0,this.currentState.limit-e);this.updateState({...this.currentState,used:e,remaining:t}),await this.saveUsage(),3===t?this.showLowUsageWarning():0===t&&this.showLimitReached(),setTimeout(()=>this.sync(),1e3)}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}updateState(e){this.currentState=e,this.listeners.forEach(t=>{try{t(e)}catch(s){}}),this.updateBadge()}updateBadge(){if(this.currentState.isPremium)return chrome.action.setBadgeText({text:"∞"}),void chrome.action.setBadgeBackgroundColor({color:"#10b981"});const e=this.currentState.remaining;0===e?(chrome.action.setBadgeText({text:"0"}),chrome.action.setBadgeBackgroundColor({color:"#ef4444"})):e<=3?(chrome.action.setBadgeText({text:e.toString()}),chrome.action.setBadgeBackgroundColor({color:"#f59e0b"})):(chrome.action.setBadgeText({text:e.toString()}),chrome.action.setBadgeBackgroundColor({color:"#8b5cf6"}))}showLowUsageWarning(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"warning",message:`Only ${this.currentState.remaining} questions left today!`,action:{text:"Upgrade",onClick:()=>this.openPricingPage()}}}).catch(()=>{})}showLimitReached(){chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{type:"error",message:"Daily limit reached! Upgrade for unlimited questions.",action:{text:"Upgrade Now",onClick:()=>this.openPricingPage()}}}).catch(()=>{})}openPricingPage(){chrome.tabs.create({url:`${d.VITE_API_URL||"https://stupify.app"}/pricing?ref=extension`})}getTimeUntilReset(){const e=new Date,t=new Date(this.currentState.resetAt).getTime()-e.getTime();if(t<0)return"Soon";const s=Math.floor(t/36e5),i=Math.floor(t%36e5/6e4);return s>0?`${s}h ${i}m`:`${i}m`}getPercentageUsed(){return 0===this.currentState.limit?0:Math.round(this.currentState.used/this.currentState.limit*100)}isToday(e){return e===this.getCurrentDate()}getCurrentDate(){return(new Date).toISOString().split("T")[0]}getNextResetTime(){const e=new Date;return e.setUTCHours(24,0,0,0),e.toISOString()}destroy(){this.syncInterval&&(window.clearInterval(this.syncInterval),this.syncInterval=null),this.listeners.clear()}};"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{g.destroy()}),"undefined"!=typeof chrome&&(null==(t=chrome.runtime.onSuspend)||t.addListener(()=>{g.destroy()}));export{h as a,o as b,u as c,g as r};
