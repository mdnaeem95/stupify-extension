var e=Object.defineProperty,t=(t,n,i)=>((t,n,i)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i)(t,"symbol"!=typeof n?n+"":n,i);import{l as n}from"./utils-CJJeYulS.js";class i{constructor(e){t(this,"minLength"),t(this,"maxLength"),t(this,"debounceMs"),t(this,"onSelectionChange"),t(this,"debounceTimer",null),t(this,"lastSelection",""),t(this,"isPaused",!1),t(this,"isDestroyed",!1),t(this,"handleMouseUp",()=>{this.isPaused||this.isDestroyed||this.debounceSelectionCheck()}),t(this,"handleSelectionChange",()=>{this.isPaused||this.isDestroyed||this.debounceSelectionCheck()}),t(this,"handleKeyUp",e=>{this.isPaused||this.isDestroyed||"Shift"===e.key&&this.debounceSelectionCheck()}),t(this,"debounceSelectionCheck",()=>{null!==this.debounceTimer&&window.clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{this.checkSelection(),this.debounceTimer=null},this.debounceMs)}),this.minLength=e.minLength,this.maxLength=e.maxLength,this.debounceMs=e.debounceMs||300,this.onSelectionChange=e.onSelectionChange,this.init()}init(){document.addEventListener("mouseup",this.handleMouseUp),document.addEventListener("selectionchange",this.handleSelectionChange),document.addEventListener("keyup",this.handleKeyUp),n.debug("SelectionHandler initialized")}checkSelection(){try{const e=this.getSelectedText();e&&e!==this.lastSelection&&e.length>=this.minLength&&(this.lastSelection=e,this.onSelectionChange&&this.onSelectionChange(e),n.debug("Selection changed:",{length:e.length,preview:e.substring(0,50)+"..."}))}catch(e){n.error("Failed to check selection:",e)}}getSelectedText(){try{const e=window.getSelection();if(!e)return"";let t=e.toString().trim();return t.length>this.maxLength&&(t=t.substring(0,this.maxLength)),t}catch(e){return n.error("Failed to get selected text:",e),""}}getSelectionDetails(){try{const e=window.getSelection();if(!e||0===e.rangeCount)return{text:"",boundingRect:null,range:null};const t=this.getSelectedText(),n=e.getRangeAt(0);return{text:t,boundingRect:n.getBoundingClientRect(),range:n}}catch(e){return n.error("Failed to get selection details:",e),{text:"",boundingRect:null,range:null}}}hasSelection(){return this.getSelectedText().length>=this.minLength}clearSelection(){try{const e=window.getSelection();e&&e.removeAllRanges(),this.lastSelection="",n.debug("Selection cleared")}catch(e){n.error("Failed to clear selection:",e)}}pause(){this.isPaused=!0,n.debug("Selection tracking paused")}resume(){this.isPaused=!1,n.debug("Selection tracking resumed")}isPausedState(){return this.isPaused}destroy(){null!==this.debounceTimer&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("selectionchange",this.handleSelectionChange),document.removeEventListener("keyup",this.handleKeyUp),this.lastSelection="",this.isDestroyed=!0,n.debug("SelectionHandler destroyed")}}const o=5e3,r="s";let s=null,a=null,c=null,l=null,d=[];function u(){return"undefined"!=typeof chrome&&void 0!==chrome.storage&&void 0!==chrome.storage.local}function h(){try{n.info("Content script initializing..."),u()||n.error("chrome.storage is not available. Extension may not work correctly."),s=new i({minLength:10,maxLength:o,onSelectionChange:g}),a=e=>{const t=navigator.platform.toUpperCase().indexOf("MAC")>=0?e.metaKey:e.ctrlKey;e.key.toLowerCase()===r&&t&&e.shiftKey&&(e.preventDefault(),e.stopPropagation(),async function(){try{const e=null==s?void 0:s.getSelectedText();if(!e||e.length<10)return void p("Please select at least 10 characters","warning");"undefined"!=typeof chrome&&chrome.runtime?(chrome.runtime.sendMessage({type:"OPEN_SIDE_PANEL",payload:{text:e,trigger:"keyboard_shortcut"}}).catch(e=>{n.error("Failed to send message:",e),p("Failed to open side panel. Please try again.","error")}),chrome.runtime.sendMessage({type:"TRACK_EVENT",payload:{event:"keyboard_shortcut_used",properties:{text_length:e.length,domain:window.location.hostname}}}).catch(e=>{n.debug("Failed to track event:",e)}),n.info("Keyboard shortcut triggered")):(n.error("chrome.runtime not available"),p("Extension not available","error"))}catch(e){n.error("Failed to handle keyboard shortcut:",e),p("Something went wrong. Please try again.","error")}}())},document.addEventListener("keydown",a),n.info("Keyboard shortcut registered"),"undefined"!=typeof chrome&&chrome.runtime?(c=(e,t,i)=>{try{return"CONTEXT_MENU_CLICKED"===e.type&&(m(),i({success:!0})),"GET_CURRENT_SELECTION"===e.type&&i({text:(null==s?void 0:s.getSelectedText())||""}),!0}catch(o){return n.error("Error in message listener:",o,t),i({success:!1,error:String(o)}),!1}},chrome.runtime.onMessage.addListener(c),n.info("Message listener registered")):n.error("chrome.runtime not available"),l=()=>{document.hidden?(null==s||s.pause(),n.debug("Selection tracking paused (tab hidden)")):(null==s||s.resume(),n.debug("Selection tracking resumed (tab visible)"))},document.addEventListener("visibilitychange",l),n.info("Content script initialized successfully")}catch(e){n.error("Failed to initialize content script:",e)}}function g(e){try{if(e.length<10)return void n.debug("Selection too short, ignoring");e.length>o&&(n.debug("Selection too long, truncating"),e=e.substring(0,o)),u()?(chrome.storage.local.set({currentSelection:{text:e,url:window.location.href,domain:window.location.hostname,timestamp:Date.now()}}).catch(e=>{n.error("Failed to store selection:",e)}),n.debug("Selection stored:",{length:e.length,domain:window.location.hostname})):n.warn("chrome.storage not available")}catch(t){n.error("Failed to handle selection change:",t)}}async function m(){try{if(!u())return n.error("chrome.storage not available"),void p("Extension storage not available","error");const e=(await chrome.storage.local.get("currentSelection")).currentSelection;if(!e||!e.text)return void p("No text selected","warning");"undefined"!=typeof chrome&&chrome.runtime?(chrome.runtime.sendMessage({type:"OPEN_SIDE_PANEL",payload:{text:e.text,trigger:"context_menu"}}).catch(e=>{n.error("Failed to send message:",e),p("Failed to open side panel. Please try again.","error")}),chrome.runtime.sendMessage({type:"TRACK_EVENT",payload:{event:"context_menu_clicked",properties:{text_length:e.text.length,domain:window.location.hostname}}}).catch(e=>{n.debug("Failed to track event:",e)}),n.info("Context menu click handled")):(n.error("chrome.runtime not available"),p("Extension not available","error"))}catch(e){n.error("Failed to handle context menu click:",e),p("Something went wrong. Please try again.","error")}}function p(e,t){if(d.length>=3){const e=d.shift();if(e){const t=e.__timeoutId;t&&clearTimeout(t),e.remove()}}const n=document.createElement("div");if(n.className="stupify-notification",n.setAttribute("data-type",t),n.textContent=e,!document.getElementById("stupify-notification-styles")){const e=document.createElement("style");e.id="stupify-notification-styles",e.textContent='\n      .stupify-notification {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        padding: 12px 20px;\n        border-radius: 8px;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        font-size: 14px;\n        font-weight: 500;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        z-index: 2147483647;\n        animation: stupify-slide-in 0.3s ease-out;\n      }\n\n      .stupify-notification[data-type="success"] {\n        background: #10b981;\n        color: white;\n      }\n\n      .stupify-notification[data-type="warning"] {\n        background: #f59e0b;\n        color: white;\n      }\n\n      .stupify-notification[data-type="error"] {\n        background: #ef4444;\n        color: white;\n      }\n\n      @keyframes stupify-slide-in {\n        from {\n          transform: translateX(400px);\n          opacity: 0;\n        }\n        to {\n          transform: translateX(0);\n          opacity: 1;\n        }\n      }\n\n      @keyframes stupify-slide-out {\n        from {\n          transform: translateX(0);\n          opacity: 1;\n        }\n        to {\n          transform: translateX(400px);\n          opacity: 0;\n        }\n      }\n    ',document.head.appendChild(e)}document.body.appendChild(n),d.push(n);const i=setTimeout(()=>{n.style.animation="stupify-slide-out 0.3s ease-in",setTimeout(()=>{n.remove(),d=d.filter(e=>e!==n)},300)},3e3);n.__timeoutId=i}function y(){var e;n.info("Cleaning up content script..."),a&&(document.removeEventListener("keydown",a),a=null),c&&(null==(e=null==chrome?void 0:chrome.runtime)?void 0:e.onMessage)&&(chrome.runtime.onMessage.removeListener(c),c=null),l&&(document.removeEventListener("visibilitychange",l),l=null),d.forEach(e=>{const t=e.__timeoutId;t&&clearTimeout(t),e.remove()}),d=[],s&&(s.destroy(),s=null),n.info("Content script cleaned up âœ…")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h(),window.addEventListener("beforeunload",y);export{y as cleanup,m as handleContextMenuClick,g as handleSelectionChange,h as init};
